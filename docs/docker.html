<!doctype html>
<html class="no-js" lang="ja">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="検索" href="search.html" /><link rel="next" title="Kubernetes" href="kubernetes.html" /><link rel="prev" title="コンテナ" href="container.html" />

    <meta name="generator" content="sphinx-4.2.0, furo 2021.10.09"/>
        <title>Docker - Untitled ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=0254c309f5cadf746f1a613e7677379ac9c8cdcd" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=16fb25fabf47304eee183a5e9af80b1ba98259b1" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Untitled  ドキュメント</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">Untitled  ドキュメント</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=検索 name="q" aria-label="検索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="vim.html">Vim</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="vscode/index.html">Visual Studio Code - vscode</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="vscode/basic.html">vscode 基本</a></li>
<li class="toctree-l2"><a class="reference internal" href="vscode/markdown.html">Markdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="vscode/powershell.html">PowerShell</a></li>
<li class="toctree-l2"><a class="reference internal" href="vscode/extensions.html">vscode 拡張機能</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="visual_studio/index.html">Visual Studio</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="visual_studio/basic.html">Visual Studio 基礎</a></li>
<li class="toctree-l2"><a class="reference internal" href="visual_studio/extensions.html">拡張機能</a></li>
<li class="toctree-l2"><a class="reference internal" href="visual_studio/powerpoint.html">PowerPoint</a></li>
<li class="toctree-l2"><a class="reference internal" href="visual_studio/cs.html">C#</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ctags.html">Ctags</a></li>
<li class="toctree-l1"><a class="reference internal" href="excel.html">Excel</a></li>
<li class="toctree-l1"><a class="reference internal" href="powerpoint.html">PowerPoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="chrome_extension.html">Chrome拡張</a></li>
<li class="toctree-l1"><a class="reference internal" href="github.html">GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="gitlab.html">GitLab</a></li>
<li class="toctree-l1"><a class="reference internal" href="mattermost.html">Mattermost</a></li>
<li class="toctree-l1"><a class="reference internal" href="html.html">HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="nodejs.html">Node JS</a></li>
<li class="toctree-l1"><a class="reference internal" href="prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="sql.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="mariadb.html">MariaDB</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="ssh.html">SSH</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="ssh_client.html">SSHクライアント</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="python.html">Python</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="python/foundation.html">Python基礎</a></li>
<li class="toctree-l2"><a class="reference internal" href="python/standard_library.html">Python3 の標準ライブラリ</a></li>
<li class="toctree-l2"><a class="reference internal" href="python/application.html">Python 応用</a></li>
<li class="toctree-l2"><a class="reference internal" href="python/jupyterlab.html">Jupyter Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="python/python2.html">Python2</a></li>
<li class="toctree-l2"><a class="reference internal" href="python/math.html">Python応用(数学)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="c.html">C言語</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp.html">C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="cs.html">C#</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="bats.html">Bats-core</a></li>
<li class="toctree-l1"><a class="reference internal" href="jq.html">jq</a></li>
<li class="toctree-l1"><a class="reference internal" href="container.html">コンテナ</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Docker</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="kubernetes.html">Kubernetes</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="kubernetes_foundation.html">Kubernetes 基礎</a></li>
<li class="toctree-l2"><a class="reference internal" href="kubernetes_kubectl.html">kubectl</a></li>
<li class="toctree-l2"><a class="reference internal" href="kubernetes_minikube.html">Minikube</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="powershell.html">PowerShell</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="powershell/powershell7.html">PowerShell 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="powershell/foundation.html">PowerShell 基礎</a></li>
<li class="toctree-l2"><a class="reference internal" href="powershell/application.html">PowerShell 応用</a></li>
<li class="toctree-l2"><a class="reference internal" href="powershell/get_childitem.html">停止しても再実行できるように、ファイルの一覧を出力する。</a></li>
<li class="toctree-l2"><a class="reference internal" href="powershell/pester.html">Pester でテストする。</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="bash.html">Bash</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="bash/foundation.html">bash基礎</a></li>
<li class="toctree-l2"><a class="reference internal" href="bash/application.html">bash応用</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="windows.html">Microsoft Windows</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="windows_foundation.html">Microsoft Windows 基礎</a></li>
<li class="toctree-l2"><a class="reference internal" href="windows_wsl.html">WSL2</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="linux.html">Linux</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="linux_foundation.html">Linux 基礎</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux_network.html">Linuxのネットワーク管理</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="debian.html">Debian</a></li>
<li class="toctree-l1"><a class="reference internal" href="ubuntu.html">Ubuntu</a></li>
<li class="toctree-l1"><a class="reference internal" href="vagrant.html">Vagrant</a></li>
<li class="toctree-l1"><a class="reference internal" href="virtualbox.html">VirtualBox</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci.html">Oracle Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="software_design.html">ソフトウェア設計</a></li>
<li class="toctree-l1"><a class="reference internal" href="atcoder.html">atcoder 競技プログラミング</a></li>
<li class="toctree-l1"><a class="reference internal" href="japanese_imperial_year.html">西暦、和暦</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="docker">
<h1>Docker<a class="headerlink" href="#docker" title="このヘッドラインへのパーマリンク">¶</a></h1>
<section id="id1">
<h2>環境<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id2">
<h3>環境1<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>次のLinux環境で作る。</p>
<ul class="simple">
<li><p>OS: Windows 10 Home</p></li>
<li><p>VirtualBox + Vagrant</p></li>
<li><p>VM: Debian(buster)</p></li>
</ul>
</section>
<section id="id3">
<h3>環境2<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>次のLinux環境で作る。</p>
<ul class="simple">
<li><p>OS: Windows 10 Home</p></li>
<li><p>VirtualBox + Vagrant</p></li>
<li><p>VM: CentOS8</p></li>
</ul>
</section>
</section>
<section id="id4">
<h2>Dockerバージョン<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Docker Engine, Docker Compose のバージョンは次の通りだった：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Client</span><span class="p">:</span> <span class="n">Docker</span> <span class="n">Engine</span> <span class="o">-</span> <span class="n">Community</span>
 <span class="n">Version</span><span class="p">:</span>           <span class="mf">20.10.5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">version</span> <span class="mf">1.29.0</span><span class="p">,</span> <span class="n">build</span> <span class="mi">07737305</span>
</pre></div>
</div>
</section>
<section id="docker-engine">
<h2>Docker Engineのインストール<a class="headerlink" href="#docker-engine" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id5">
<h3>環境1,2共通<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># 管理者で実行</span>
<span class="n">choco</span> <span class="n">install</span> <span class="n">virtualbox</span>
<span class="n">choco</span> <span class="n">install</span> <span class="n">vagrant</span>
</pre></div>
</div>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># VirtualBox の VM に Guest Addtion をインストールする。</span>
<span class="n">vagrant</span> <span class="n">plugin</span> <span class="n">install</span> <span class="n">vagrant-vbguest</span>
</pre></div>
</div>
</section>
<section id="docker-engine-debian">
<h3>環境1: Docker Engineをインストールする Debian マシンを準備する<a class="headerlink" href="#docker-engine-debian" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$lines</span> <span class="p">=</span> <span class="sh">@'</span>
<span class="sh">Vagrant.configure("2") do |config|</span>
<span class="sh">  # Dockerが対応しているものならなんでもよい。</span>
<span class="sh">  # Debian(buster)を選んだ。</span>
<span class="sh">  config.vm.box = "debian/buster64"</span>

<span class="sh">  config.vm.provider "virtualbox" do |vb|</span>
<span class="sh">    # VMのメモリは1GBにする。</span>
<span class="sh">    vb.memory = "1024"</span>
<span class="sh">  end</span>

<span class="sh">  # 使わないから無効にする。</span>
<span class="sh">  config.vm.synced_folder '.', '/vagrant', disabled: true</span>
<span class="sh">end</span>
<span class="sh">'@</span>

<span class="nv">$dir</span> <span class="p">=</span> <span class="nb">Get-Location</span>
<span class="nv">$vagrantfileFullName</span> <span class="p">=</span> <span class="nb">Join-Path</span> <span class="nv">$dir</span> <span class="s2">"Vagrantfile"</span>
<span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllLines</span><span class="p">(</span><span class="nv">$vagrantfileFullName</span><span class="p">,</span> <span class="nv">$lines</span><span class="p">)</span>

<span class="c">#vagrant destroy --force</span>
<span class="n">vagrant</span> <span class="n">up</span>

<span class="n">vagrant</span> <span class="n">ssh</span>

<span class="c"># Vagrantfile 変更を反映させるために実行する。初回は不要。</span>
<span class="c">#vagrant reload</span>
</pre></div>
</div>
<p>もし ssh コマンドでログインする場合：</p>
<div class="highlight-ps1 notranslate"><div class="highlight"><pre><span></span><span class="nv">$sshConfigFullName</span> <span class="p">=</span> <span class="nb">Join-Path</span> <span class="nv">$dir</span> <span class="s2">"ssh_config.cache"</span>
<span class="nv">$sshConfigString</span> <span class="p">=</span> <span class="n">vagrant</span> <span class="n">ssh-config</span>
<span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllLines</span><span class="p">(</span><span class="nv">$sshConfigFullName</span><span class="p">,</span> <span class="nv">$sshConfigString</span><span class="p">)</span>

<span class="c"># vagrant ssh の代わりにこれを使って、仮想マシンのSSHサーバにSSHする。</span>
<span class="c"># 仮想マシンの 80/tcp を SSH クライアントの 10080/tcp に転送することにより</span>
<span class="c"># SSH クライアントで http://127.0.0.1:10080/ にアクセスすると、</span>
<span class="c"># 仮想マシンの 80/tcp にアクセスできるようにする。</span>
<span class="n">ssh</span> <span class="o">-F</span> <span class="n">ssh_config</span><span class="p">.</span><span class="n">cache</span> <span class="n">-L</span> <span class="n">10080</span><span class="p">:</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">80</span> <span class="n">-L</span> <span class="n">20080</span><span class="p">:</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">10080</span> <span class="n">-L</span> <span class="n">3000</span><span class="p">:</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">3000</span> <span class="k">default</span>
</pre></div>
</div>
</section>
<section id="docker-engine-centos8">
<h3>環境2: Docker Engineをインストールする CentOS8 マシンを準備する<a class="headerlink" href="#docker-engine-centos8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$lines</span> <span class="p">=</span> <span class="sh">@'</span>
<span class="sh">Vagrant.configure("2") do |config|</span>
<span class="sh">  # Dockerが対応しているものならなんでもよい。</span>
<span class="sh">  # Debian(buster)を選んだ。</span>
<span class="sh">  config.vm.box = "centos/7"</span>

<span class="sh">  config.vm.provider "virtualbox" do |vb|</span>
<span class="sh">    # VMのメモリは1GBにする。</span>
<span class="sh">    vb.memory = "1024"</span>
<span class="sh">  end</span>

<span class="sh">  # 使わないから無効にする。</span>
<span class="sh">  config.vm.synced_folder '.', '/vagrant', disabled: true</span>
<span class="sh">end</span>
<span class="sh">'@</span>

<span class="nv">$dir</span> <span class="p">=</span> <span class="nb">Get-Location</span>
<span class="nv">$vagrantfileFullName</span> <span class="p">=</span> <span class="nb">Join-Path</span> <span class="nv">$dir</span> <span class="s2">"Vagrantfile"</span>
<span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllLines</span><span class="p">(</span><span class="nv">$vagrantfileFullName</span><span class="p">,</span> <span class="nv">$lines</span><span class="p">)</span>

<span class="c">#vagrant destroy --force</span>
<span class="n">vagrant</span> <span class="n">up</span>

<span class="c"># 遅すぎるので使わない。</span>
<span class="c">#vagrant ssh</span>

<span class="c"># Vagrantfile 変更を反映させるために実行する。初回は不要。</span>
<span class="c">#vagrant reload</span>

<span class="nv">$sshConfigFullName</span> <span class="p">=</span> <span class="nb">Join-Path</span> <span class="nv">$dir</span> <span class="s2">"ssh_config.cache"</span>
<span class="nv">$sshConfigString</span> <span class="p">=</span> <span class="n">vagrant</span> <span class="n">ssh-config</span>
<span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllLines</span><span class="p">(</span><span class="nv">$sshConfigFullName</span><span class="p">,</span> <span class="nv">$sshConfigString</span><span class="p">)</span>

<span class="c"># vagrant ssh の代わりにこれを使って、仮想マシンのSSHサーバにSSHする。</span>
<span class="c"># 仮想マシンの 80/tcp を SSH クライアントの 10080/tcp に転送することにより</span>
<span class="c"># SSH クライアントで http://127.0.0.1:10080/ にアクセスすると、</span>
<span class="c"># 仮想マシンの 80/tcp にアクセスできるようにする。</span>
<span class="n">ssh</span> <span class="o">-F</span> <span class="n">ssh_config</span><span class="p">.</span><span class="n">cache</span> <span class="n">-L</span> <span class="n">10080</span><span class="p">:</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">80</span> <span class="n">-L</span> <span class="n">3000</span><span class="p">:</span><span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span><span class="p">:</span><span class="n">3000</span> <span class="k">default</span>
</pre></div>
</div>
</section>
<section id="linuxdocker-engine">
<h3>LinuxマシンにDocker Engineをインストールする<a class="headerlink" href="#linuxdocker-engine" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>https://docs.docker.com/engine/install/</p>
<section id="debian-docker-engine">
<h4>環境1: Debian に Docker Engine をインストールする<a class="headerlink" href="#debian-docker-engine" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>あまりに古いと依存関係で死ぬ。</p>
<p>https://docs.docker.com/engine/install/debian/</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># SET UP THE REPOSITORY</span>
sudo apt-get update
sudo apt-get install <span class="se">\</span>
    apt-transport-https <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    curl <span class="se">\</span>
    gnupg <span class="se">\</span>
    lsb-release

curl -fsSL https://download.docker.com/linux/debian/gpg <span class="se">\</span>
<span class="p">|</span> sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

<span class="nb">echo</span> <span class="se">\</span>
<span class="s2">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \</span>
<span class="k">$(</span>lsb_release -cs<span class="k">)</span><span class="s2"> stable"</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null

<span class="c1"># INSTALL DOCKER ENGINE</span>
sudo apt-get update
apt-cache madison docker-ce
sudo apt-get install docker-ce docker-ce-cli containerd.io

<span class="c1"># Verify that Docker Engine is installed correctly by running the hello-world image.</span>
sudo docker run hello-world
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># docker コマンドを sudo せずに使えるようにする</span>
sudo groupadd docker
sudo usermod -aG docker <span class="nv">$USER</span>
newgrp docker
docker run hello-world
</pre></div>
</div>
</section>
<section id="centos7-docker-engine">
<h4>環境2: CentOS7 に Docker Engine をインストールする<a class="headerlink" href="#centos7-docker-engine" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo yum install -y yum-utils
sudo yum-config-manager <span class="se">\</span>
    --add-repo <span class="se">\</span>
    https://download.docker.com/linux/centos/docker-ce.repo

sudo yum install docker-ce docker-ce-cli containerd.io -y

sudo systemctl start docker

sudo docker run hello-world

<span class="nb">echo</span> <span class="nv">$USER</span>
sudo usermod -aG docker <span class="nv">$USER</span>
    <span class="c1"># usermod の後で、設定を反映するためにログアウト、ログインする</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id6">
<h2>コンテナイメージ、イメージ<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="docker-hub">
<h3>Docker Hub レジストリのイメージ一覧を見る<a class="headerlink" href="#docker-hub" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>https://hub.docker.com/</p>
</section>
<section id="id7">
<h3>ローカルにあるイメージの一覧を得る<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ローカルにあるイメージの一覧を得る。</span>
docker image ls

<span class="c1"># intermediate なイメージを含める。</span>
docker image ls --all

<span class="c1"># 指定したリポジトリのイメージの一覧を得る。</span>
docker image ls hello-world

<span class="c1"># 同イメージID、異リポジトリ名のイメージ一覧を得る。</span>
<span class="c1"># `--filter` は ID 指定できないので、 docker コマンド外で対応する必要がある。</span>
docker image ls <span class="p">|</span> grep -e <span class="s2">"^REPO"</span> -e <span class="s2">"</span><span class="nv">$image_id</span><span class="s2">"</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>Docker Hub レジストリからイメージを得て、そのイメージを加える<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># リポジトリを指定して得る。</span>
docker pull hello-world

<span class="c1"># リポジトリを指定して得る。</span>
docker pull alpine

<span class="c1"># リポジトリとタグを指定して得る。</span>
docker pull hello-world:latest

<span class="c1"># リポジトリとタグを指定して得る。</span>
docker pull debian:buster
</pre></div>
</div>
</section>
<section id="id9">
<h3>イメージに変更を加えた別イメージを作る<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">name_tag</span><span class="o">=</span><span class="s2">"local-debian-helloworld"</span>

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/tmp-</span><span class="si">${</span><span class="nv">name_tag</span><span class="si">}</span><span class="s2">"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee ./Dockerfile</span>
<span class="s">FROM debian:buster</span>
<span class="s">CMD ["/bin/bash", "-c", "echo helloworld"]</span>
<span class="s">__DOCKERFILE__</span>

docker build -t <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> .
    <span class="c1"># Sending build context to Docker daemon  2.048kB</span>
    <span class="c1"># Step 1/2 : FROM debian:buster</span>
    <span class="c1">#  ---&gt; 463adba1ec3f</span>
    <span class="c1"># Step 2/2 : CMD ["/bin/bash", "-c", "echo helloworld"]</span>
    <span class="c1">#  ---&gt; Running in a90d6a2f2daa</span>
    <span class="c1"># Removing intermediate container a90d6a2f2daa</span>
    <span class="c1">#  ---&gt; 2d7abd8b2fb7</span>
    <span class="c1"># Successfully built 2d7abd8b2fb7</span>
    <span class="c1"># Successfully tagged local-debian-helloworld:latest</span>

docker image ls <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
    <span class="c1"># REPOSITORY                TAG       IMAGE ID       CREATED          SIZE</span>
    <span class="c1"># local-debian-helloworld   latest    2d7abd8b2fb7   21 seconds ago   114MB</span>

<span class="c1"># もし加えたイメージを実行するなら次の行を実行する</span>
docker run <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
    <span class="c1"># helloworld</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3>公開するポートを指定したイメージを作る<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">name_tag</span><span class="o">=</span><span class="s2">"local-debian-port8000"</span>

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/tmp-</span><span class="si">${</span><span class="nv">name_tag</span><span class="si">}</span><span class="s2">"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee ./Dockerfile</span>
<span class="s">FROM debian:buster</span>
<span class="s">RUN apt-get update &amp;&amp; apt-get install python3 -y</span>
<span class="s">WORKDIR /</span>
<span class="s">CMD ["/usr/bin/python3", "-m", "http.server"]</span>
<span class="s">EXPOSE 8000</span>
<span class="s">__DOCKERFILE__</span>

docker build -t <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> .

docker image ls <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
    <span class="c1"># REPOSITORY            TAG       IMAGE ID       CREATED         SIZE</span>
    <span class="c1"># local-debian-port80   latest    d9337ef0dddc   5 seconds ago   114MB</span>

<span class="c1"># もし加えたイメージを実行するなら次の行を実行する</span>
docker run -dp <span class="m">18000</span>:8000 <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
    <span class="c1"># CONTAINER ID   IMAGE                   COMMAND                  CREATED              STATUS              PORTS                                         NAMES</span>
    <span class="c1"># 7723abae0c9a   local-debian-port8000   "/usr/bin/python3 -m…"   About a minute ago   Up About a minute   0.0.0.0:18000-&gt;8000/tcp, :::18000-&gt;8000/tcp   keen_knuth</span>

curl -s http://localhost:18000/
</pre></div>
</div>
</section>
<section id="id11">
<h3>マルチステージでイメージを作る<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">name_tag</span><span class="o">=</span><span class="s2">"local-debian-hello-clang"</span>

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/tmp-</span><span class="si">${</span><span class="nv">name_tag</span><span class="si">}</span><span class="s2">"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

cat <span class="s">&lt;&lt;'__CLANG__' | tee ./hello.c</span>
<span class="s">#include &lt;stdio.h&gt;</span>
<span class="s">int main(int argc, char **argv)</span>
<span class="s">{</span>
<span class="s">    puts("hello");</span>
<span class="s">    return 0;</span>
<span class="s">}</span>
<span class="s">__CLANG__</span>

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee ./Dockerfile</span>
<span class="s">FROM debian:buster AS build</span>
<span class="s">ENV DEBCONF_NOWARNINGS yes</span>
<span class="s">RUN apt-get update \</span>
<span class="s">  &amp;&amp; apt-get install -y clang</span>
<span class="s">WORKDIR /app</span>
<span class="s">COPY . .</span>
<span class="s">RUN clang hello.c -o hello</span>

<span class="s">FROM debian:buster</span>
<span class="s">COPY --from=build /app/hello /usr/local/bin/hello</span>
<span class="s">CMD ["/usr/local/bin/hello"]</span>
<span class="s">__DOCKERFILE__</span>

docker build -t <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> .

docker image ls <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>

docker run <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
    <span class="c1"># hello</span>

docker run -it <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> dpkg --list --no-pager <span class="p">|</span> grep clang
    <span class="c1"># 何も出力されない</span>
<span class="nb">echo</span> <span class="nv">$?</span>
    <span class="c1"># --&gt; 1</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3>イメージをスキャンする<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>https://docs.docker.com/engine/scan/#prerequisites
debian では対応していない。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker scan <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker scan
docker: 'scan' is not a docker command.
See 'docker --help'
</pre></div>
</div>
</section>
<section id="id13">
<h3>イメージを消す<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">repository_tag</span><span class="o">=</span><span class="s2">"alpine"</span>

docker image ls <span class="s2">"</span><span class="nv">$repository_tag</span><span class="s2">"</span>

<span class="nv">image_id_list</span><span class="o">=</span><span class="k">$(</span>docker image ls --format <span class="s2">"{{.ID}}"</span> <span class="s2">"</span><span class="nv">$repository_tag</span><span class="s2">"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$image_id_list</span><span class="s2">"</span>
docker image rm <span class="s2">"</span><span class="nv">$image_id_list</span><span class="s2">"</span>

<span class="c1"># 異なるリポジトリ名で、同じIDの場合、消すために強制の指定が必要です。</span>
<span class="nv">image_id_list</span><span class="o">=</span><span class="k">$(</span>docker image ls --format <span class="s2">"{{.ID}}"</span> <span class="s2">"</span><span class="nv">$repository_tag</span><span class="s2">"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$image_id_list</span><span class="s2">"</span>
<span class="nb">echo</span> docker image rm --force <span class="nv">$image_id_list</span>
docker image rm --force <span class="nv">$image_id_list</span>
</pre></div>
</div>
</section>
<section id="docker-hub-push">
<h3>イメージを Docker Hub レジストリに push する<a class="headerlink" href="#docker-hub-push" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>https://docs.docker.com/get-started/04_sharing_app/</p>
</section>
</section>
<section id="id14">
<h2>ボリューム<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id15">
<h3>ボリュームの一覧を得る<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker volume ls

docker volume ls --format <span class="s2">"{{ .Name }}"</span>
</pre></div>
</div>
<p>https://docs.docker.com/engine/reference/commandline/volume_ls/</p>
</section>
<section id="id16">
<h3>ボリュームを作る<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker volume create todo-db

<span class="c1"># 同じボリュームを作ろうとしてもエラーは発生しなかった</span>
docker volume create todo-db
<span class="nb">echo</span> <span class="nv">$?</span>
</pre></div>
</div>
</section>
<section id="id17">
<h3>ボリュームを消す<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker volume rm todo-db
</pre></div>
</div>
</section>
</section>
<section id="id18">
<h2>コンテナ概要<a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id19">
<h3>コンテナの一覧を得る<a class="headerlink" href="#id19" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 起動中のみを対象に一覧を得る。</span>
docker container ls

<span class="c1"># 起動していないコンテナを含む。</span>
docker container ls --all

<span class="c1"># 条件にあうコンテナを得る。</span>
docker container ls --all --filter <span class="s2">"ancestor=hello-world"</span>

<span class="c1"># 結果の出力形式を変えて、IDのみ出力する。</span>
docker container ls --all --format <span class="s2">"{{.ID}}"</span>

<span class="nb">echo</span> docker run -dp <span class="m">3000</span>:3000 <span class="se">\</span>
    -w /app -v <span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">:/app"</span> <span class="se">\</span>
    node:12-alpine <span class="se">\</span>
    sh -c <span class="s2">"yarn install &amp;&amp; yarn run dev"</span>
</pre></div>
</div>
</section>
<section id="id20">
<h3>公開されているイメージから新しいコンテナを作って実行する<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>イメージ hello-world は出力してすぐ終了するように作られたコンテナです。</p>
<p>https://hub.docker.com/_/hello-world</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># もしイメージがなければイメージをローカルに得て、</span>
<span class="c1"># そのイメージよりコンテナを作って実行する。</span>
<span class="c1"># hello-world の出力が結果として画面に表示される。</span>
docker run hello-world
</pre></div>
</div>
</section>
<section id="id21">
<h3>実行中のコンテナを停止する<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">container_id</span><span class="o">=</span><span class="s2">"3cac8331e287"</span>
docker stop <span class="s2">"</span><span class="nv">$container_id</span><span class="s2">"</span>
</pre></div>
</div>
</section>
<section id="id22">
<h3>コンテナを消す<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="bash">
<h4>bash でコンテナを消す。<a class="headerlink" href="#bash" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># コンテナIDで消す</span>
<span class="c1"># 先頭がユニークならコンテナのIDの先頭N文字でも消せそう</span>
docker container rm <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># hello-world が祖先であるコンテナを消す</span>
<span class="nv">ancestor</span><span class="o">=</span><span class="s2">"hello-world"</span>
docker container ls --filter <span class="s2">"ancestor=</span><span class="nv">$ancestor</span><span class="s2">"</span> --format <span class="s2">"{{.ID}}"</span> <span class="se">\</span>
<span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> -r cid<span class="p">;</span> <span class="k">do</span>
    docker container rm <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
  <span class="k">done</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># exited なコンテナを消す</span>
docker container ls --filter <span class="s2">"status=exited"</span> --format <span class="s2">"{{.ID}}"</span> <span class="se">\</span>
<span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> -r cid<span class="p">;</span> <span class="k">do</span>
    docker container rm <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
  <span class="k">done</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># すべてのコンテナを消す</span>
docker container ls --all --format <span class="s2">"{{.ID}}"</span> <span class="se">\</span>
<span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> -r cid<span class="p">;</span> <span class="k">do</span>
    docker container rm <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
  <span class="k">done</span>
</pre></div>
</div>
</section>
<section id="powershell">
<h4>PowerShell でコンテナを消す。<a class="headerlink" href="#powershell" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># exited なコンテナを消す</span>
<span class="n">docker</span> <span class="n">container</span> <span class="nb">ls </span><span class="p">-</span><span class="n">-filter</span> <span class="s2">"status=exited"</span> <span class="p">-</span><span class="n">-format</span> <span class="s2">"{{.ID}}"</span> <span class="p">|</span>
<span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="n">docker</span> <span class="n">container</span> <span class="nb">rm </span><span class="s2">"$_"</span> <span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id23">
<h2>コンテナ単体<a class="headerlink" href="#id23" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id24">
<h3>コンテナを起動する時、指定コマンドを実行する<a class="headerlink" href="#id24" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run debian:buster cat /etc/passwd
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker run debian:buster cat /etc/passwd

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
vagrant@buster:~$
</pre></div>
</div>
</section>
<section id="id25">
<h3>コンテナを起動する時、インタラクティブなコマンドを実行する<a class="headerlink" href="#id25" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># debian コンテナを作り、コンテナ内で bash を実行する。</span>
<span class="c1"># -i はインタラクティブ, -t は tty</span>
docker run -it debian:buster bash
  <span class="c1"># exit などでコンテナホストに戻る</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker run -it debian:buster bash
root@383a7ace522a:/# whoami
root
root@383a7ace522a:/# exit
exit
vagrant@buster:~$
</pre></div>
</div>
</section>
<section id="id26">
<h3>コンテナをデタッチで起動して、起動後にログを得る<a class="headerlink" href="#id26" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">container_id</span><span class="o">=</span><span class="k">$(</span>docker run --detach hello-world<span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$container_id</span><span class="s2">"</span>
docker logs <span class="s2">"</span><span class="nv">$container_id</span><span class="s2">"</span>

<span class="c1"># ログは何度でも取得できる</span>
docker logs <span class="s2">"</span><span class="nv">$container_id</span><span class="s2">"</span>
</pre></div>
</div>
</section>
<section id="id27">
<h3>コンテナを起動する時、環境変数を設定する<a class="headerlink" href="#id27" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it -e <span class="nv">ENV1</span><span class="o">=</span>a debian:buster /bin/bash
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$ENV1</span><span class="s2">"</span>
    <span class="c1"># --&gt; a</span>
</pre></div>
</div>
</section>
<section id="id28">
<h3>コンテナを起動する時、コンテナの名前をつける<a class="headerlink" href="#id28" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -d --name foo debian:buster tail -f /dev/null

docker container ls
    <span class="c1"># vagrant@buster:~$ docker container ls</span>
    <span class="c1"># CONTAINER ID   IMAGE           COMMAND               CREATED          STATUS          PORTS     NAMES</span>
    <span class="c1"># 9350cc021526   debian:buster   "tail -f /dev/null"   16 seconds ago   Up 15 seconds             foo</span>

<span class="c1"># コンテナの名前で停止できる</span>
docker container stop foo
    <span class="c1"># vagrant@buster:~$ docker container stop foo</span>
    <span class="c1"># foo</span>
</pre></div>
</div>
</section>
</section>
<section id="id29">
<h2>Docker Engine とコンテナ<a class="headerlink" href="#id29" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id30">
<h3>Docker Engine サービス起動時にコンテナを起動する<a class="headerlink" href="#id30" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># コンテナを起動する</span>
docker run -d <span class="se">\</span>
    --name my_container <span class="se">\</span>
    debian:buster tail -f /dev/null
docker run -d --restart<span class="o">=</span>always <span class="se">\</span>
    --name my_restart_always_container <span class="se">\</span>
    debian:buster tail -f /dev/null

<span class="c1"># コンテナを確認する</span>
docker container ls --all <span class="p">|</span> grep -Pe <span class="s1">'^CONTAINER|my\S*_container'</span>
    <span class="c1"># vagrant@buster:~$ docker container ls --all | grep -Pe '^CONTAINER|my\S*_container'</span>
    <span class="c1"># CONTAINER ID   IMAGE                      COMMAND                  CREATED             STATUS                         PORTS                    NAMES</span>
    <span class="c1"># ca05e65ed5a0   debian:buster              "tail -f /dev/null"      18 minutes ago      Up 18 minutes                                           my_restart_always_container</span>
    <span class="c1"># 82c43655090d   debian:buster              "tail -f /dev/null"      18 minutes ago      Up 18 minutes                                           my_container</span>

<span class="c1"># RestartPolicy を確認する</span>
docker container inspect my_restart_always_container <span class="p">|</span> jq -r .<span class="o">[</span><span class="m">0</span><span class="o">]</span>.HostConfig.RestartPolicy.Name
    <span class="c1"># vagrant@buster:~$ docker container inspect my_restart_always_container | jq -r .[0].HostConfig.RestartPolicy.Name</span>
    <span class="c1"># always</span>
docker container inspect my_container <span class="p">|</span> jq -r .<span class="o">[</span><span class="m">0</span><span class="o">]</span>.HostConfig.RestartPolicy.Name
    <span class="c1"># vagrant@buster:~$ docker container inspect my_container | jq -r .[0].HostConfig.RestartPolicy.Name</span>
    <span class="c1"># no</span>

<span class="c1"># Docker Engine の停止方法がわからず、ここではOSを再起動した</span>
sudo systemctl reboot

docker container ls
    <span class="c1"># vagrant@buster:~$ docker container ls</span>
    <span class="c1"># CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS                    NAMES</span>
    <span class="c1"># ca05e65ed5a0   debian:buster   "tail -f /dev/null"      30 minutes ago   Up 39 seconds                            my_restart_always_container</span>
</pre></div>
</div>
</section>
<section id="id31">
<h3>Docker Engine を停止する<a class="headerlink" href="#id31" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>todo: 停止できなかった。
次の出力で自動起動してきた。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl stop docker.service
    <span class="c1"># vagrant@buster:~$ sudo systemctl stop docker.service</span>
    <span class="c1"># Warning: Stopping docker.service, but it can still be activated by:</span>
    <span class="c1">#   docker.socket</span>
</pre></div>
</div>
</section>
</section>
<section id="id32">
<h2>コンテナとコンテナホスト間のネットワーク通信<a class="headerlink" href="#id32" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="tcp">
<h3>コンテナを起動する時、コンテナホスト宛のTCP通信を、コンテナに転送する<a class="headerlink" href="#tcp" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># コンテナホストの 10080/tcp 宛の通信をコンテナ内の 80/tcp に転送する</span>
docker run -p <span class="m">10080</span>:80 docker/getting-started
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 別ターミナルで確認する</span>
docker container ls --last <span class="m">1</span>
<span class="nv">cid</span><span class="o">=</span><span class="k">$(</span>docker container ls --last <span class="m">1</span> --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
docker container <span class="nb">exec</span> -it <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span> netstat -nlt
sudo ss -nltp <span class="p">|</span> grep -e ^State -e :10080
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker container ls --last 1
CONTAINER ID   IMAGE                    COMMAND                  CREATED
      STATUS              PORTS                   NAMES
6ae884fad0f6   docker/getting-started   "/docker-entrypoint.…"   About a minute ago   Up About a minute   0.0.0.0:10080-&gt;80/tcp   vigilant_solomon
vagrant@buster:~$ cid=$(docker container ls --last 1 --format "{{.ID}}")
vagrant@buster:~$ echo "$cid"
6ae884fad0f6
vagrant@buster:~$ docker container exec -it "$cid" netstat -nlt
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN
tcp        0      0 :::80                   :::*                    LISTEN
vagrant@buster:~$ sudo ss -nltp | grep -e ^State -e :10080
State     Recv-Q    Send-Q       Local Address:Port        Peer Address:Port

LISTEN    0         128                0.0.0.0:10080            0.0.0.0:*
 users:(("docker-proxy",pid=2937,fd=4))
vagrant@buster:~$
</pre></div>
</div>
</section>
<section id="id33">
<h3>コンテナ内から、コンテナホストより外に通信する<a class="headerlink" href="#id33" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>「コンテナと、コンテナホストのIPネットワークを確認する」を参照</p>
</section>
</section>
<section id="id34">
<h2>コンテナとネットワーク<a class="headerlink" href="#id34" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id35">
<h3>ネットワークを作る<a class="headerlink" href="#id35" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ネットワークの一覧を得る</span>
docker network ls

<span class="c1"># ネットワークを作る</span>
docker network create todo-app

<span class="c1"># 同じネットワークを重複して作ることは許されなかった</span>
docker network create todo-app
<span class="nb">echo</span> <span class="nv">$?</span>
  <span class="c1"># --&gt; 1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~/getting-started/app$ docker network ls
NETWORK ID     NAME       DRIVER    SCOPE
84a1caa9d570   bridge     bridge    local
080a258075d6   host       host      local
830ccf141f28   none       null      local
9f43d51fde56   todo-app   bridge    local
</pre></div>
</div>
</section>
<section id="id36">
<h3>ネットワークに接続して、コンテナを起動する<a class="headerlink" href="#id36" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker network create todo-app
<span class="nv">nid</span><span class="o">=</span><span class="k">$(</span>docker network ls --format <span class="s2">"{{.ID}}"</span> --filter <span class="s2">"name=todo-app"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$nid</span><span class="s2">"</span>
docker network inspect <span class="s2">"</span><span class="nv">$nid</span><span class="s2">"</span>

docker run -d <span class="se">\</span>
--network todo-app --network-alias mysql <span class="se">\</span>
-v todo-mysql-data:/var/lib/mysql <span class="se">\</span>
-e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>secret <span class="se">\</span>
-e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>todos <span class="se">\</span>
mysql:5.7
</pre></div>
</div>
</section>
</section>
<section id="id37">
<h2>コンテナとコンテナホストのファイルアクセス<a class="headerlink" href="#id37" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id38">
<h3>ボリュームを接続して、コンテナを起動する<a class="headerlink" href="#id38" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
git clone https://github.com/docker/getting-started.git
<span class="nb">cd</span> getting-started/app

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee Dockerfile &gt;/dev/null</span>
<span class="s">FROM node:12-alpine</span>
<span class="s">RUN apk add --no-cache python g++ make</span>
<span class="s">WORKDIR /app</span>
<span class="s">COPY . .</span>
<span class="s">RUN yarn install --production</span>
<span class="s">CMD ["node", "src/index.js"]</span>
<span class="s">__DOCKERFILE__</span>

docker build -t getting-started .

docker image ls

docker run -dp <span class="m">3000</span>:3000 getting-started

docker container ls --last <span class="m">1</span>
<span class="nv">cid</span><span class="o">=</span><span class="k">$(</span>docker container ls --last <span class="m">1</span> --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
docker stop <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>

<span class="c1"># ボリュームを作る</span>
<span class="c1"># なお、ここで作らなくても、 run 時にもしなければボリュームは作られる</span>
docker volume ls
docker volume create todo-db
docker volume ls

<span class="c1"># ボリューム todo-db を /etc/todos として接続して、コンテナを起動する</span>
docker run -dp <span class="m">3000</span>:3000 -v todo-db:/etc/todos getting-started
<span class="nv">cid</span><span class="o">=</span><span class="k">$(</span>docker container ls --last <span class="m">1</span> --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
docker stop <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>

<span class="c1"># ボリューム todo-db を /etc/todos として接続して、コンテナを起動する</span>
docker run -dp <span class="m">3000</span>:3000 -v todo-db:/etc/todos getting-started

docker volume inspect todo-db
sudo ls -al /var/lib/docker/volumes/todo-db/_data
    <span class="c1"># --&gt; todo.db</span>
</pre></div>
</div>
</section>
<section id="bind-mount">
<h3>bind mount を接続して、コンテナを起動する<a class="headerlink" href="#bind-mount" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
git clone https://github.com/docker/getting-started.git
<span class="nb">cd</span> getting-started/app

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee Dockerfile &gt;/dev/null</span>
<span class="s">FROM node:12-alpine</span>
<span class="s">RUN apk add --no-cache python g++ make</span>
<span class="s">WORKDIR /app</span>
<span class="s">COPY . .</span>
<span class="s">RUN yarn install --production</span>
<span class="s">CMD ["node", "src/index.js"]</span>
<span class="s">__DOCKERFILE__</span>

docker build -t getting-started .

docker image ls

<span class="c1"># -v で bind mount を指定する。</span>
<span class="c1"># カレントディレクトリを、コンテナ内の /app に紐づける。</span>
docker run -dp <span class="m">3000</span>:3000 <span class="se">\</span>
    -w /app -v <span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">:/app"</span> <span class="se">\</span>
    node:12-alpine <span class="se">\</span>
    sh -c <span class="s2">"yarn install &amp;&amp; yarn run dev"</span>

docker container ls --last <span class="m">1</span>
<span class="nv">cid</span><span class="o">=</span><span class="k">$(</span>docker container ls --last <span class="m">1</span> --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
docker logs -f <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">cid</span><span class="o">=</span><span class="k">$(</span>docker container ls --last <span class="m">1</span> --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span>
docker <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span> ls -dl /app
docker <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span> ls -l /app
docker <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span> touch /app/a.txt
docker <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span> ls -l /app
ls -l ./

touch ./b.txt
ls -l ./
docker <span class="nb">exec</span> <span class="s2">"</span><span class="nv">$cid</span><span class="s2">"</span> ls -l /app
</pre></div>
</div>
</section>
</section>
<section id="docker-compose">
<h2>Docker Compose のインストール<a class="headerlink" href="#docker-compose" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo curl -L <span class="s2">"https://github.com/docker/compose/releases/download/1.29.0/docker-compose-</span><span class="k">$(</span>uname -s<span class="k">)</span><span class="s2">-</span><span class="k">$(</span>uname -m<span class="k">)</span><span class="s2">"</span> -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
</pre></div>
</div>
</section>
<section id="id39">
<h2>コンテナ間通信、docker-compose<a class="headerlink" href="#id39" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="compose">
<h3>Compose ファイルを作る<a class="headerlink" href="#compose" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
git clone https://github.com/docker/getting-started.git
<span class="nb">cd</span> getting-started/app

cat <span class="s">&lt;&lt;'__DOCKER_COMPOSE_YML__' | tee docker-compose.yml</span>
<span class="s">version: "3.7"</span>

<span class="s">services:</span>
<span class="s">  app:</span>
<span class="s">    image: node:12-alpine</span>
<span class="s">    command: sh -c "yarn install &amp;&amp; yarn run dev"</span>
<span class="s">    ports:</span>
<span class="s">      - 3000:3000</span>
<span class="s">    working_dir: /app</span>
<span class="s">    volumes:</span>
<span class="s">      - ./:/app</span>
<span class="s">    environment:</span>
<span class="s">      MYSQL_HOST: mysql</span>
<span class="s">      MYSQL_USER: root</span>
<span class="s">      MYSQL_PASSWORD: secret</span>
<span class="s">      MYSQL_DB: todos</span>

<span class="s">  mysql:</span>
<span class="s">    image: mysql:5.7</span>
<span class="s">    volumes:</span>
<span class="s">      - todo-mysql-data:/var/lib/mysql</span>
<span class="s">    environment:</span>
<span class="s">      MYSQL_ROOT_PASSWORD: secret</span>
<span class="s">      MYSQL_DATABASE: todos</span>

<span class="s">volumes:</span>
<span class="s">  todo-mysql-data:</span>
<span class="s">__DOCKER_COMPOSE_YML__</span>
</pre></div>
</div>
</section>
<section id="docker-compose-yml">
<h3>docker-compose.yml でコンテナを起動する<a class="headerlink" href="#docker-compose-yml" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
<span class="nb">cd</span> getting-started/app

docker-compose up -d

docker-compose logs -f
</pre></div>
</div>
</section>
</section>
<section id="id40">
<h2>コンテナイメージ<a class="headerlink" href="#id40" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="scratch">
<h3>scratch コンテナイメージ<a class="headerlink" href="#scratch" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="id41">
<h4>scratch コンテナイメージとは<a class="headerlink" href="#id41" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>イメージ hello-world は <a class="reference external" href="https://github.com/docker-library/hello-world/blob/master/amd64/hello-world/Dockerfile">Dockerfile の記載</a>の通り <a class="reference external" href="https://hub.docker.com/_/scratch">scratch イメージ</a>から作られている。</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">scratch</span>
<span class="k">COPY</span> hello /
<span class="k">CMD</span> <span class="p">[</span><span class="s2">"/hello"</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="id42">
<h4>scratch イメージに対する調査<a class="headerlink" href="#id42" title="このヘッドラインへのパーマリンク">¶</a></h4>
<section id="sh">
<h5>sh を動かせるようにする<a class="headerlink" href="#sh" title="このヘッドラインへのパーマリンク">¶</a></h5>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">bin_path</span><span class="o">=</span>/bin/sh
<span class="nv">repository</span><span class="o">=</span>local-scrach-sh

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/sh"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

ldd <span class="s2">"</span><span class="nv">$bin_path</span><span class="s2">"</span>
    <span class="c1"># linux-vdso.so.1 (0x00007fff71470000)</span>
    <span class="c1"># libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffabebbb000)</span>
    <span class="c1"># /lib64/ld-linux-x86-64.so.2 (0x00007ffabeda4000)</span>

<span class="o">(</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$bin_path</span><span class="s2">"</span>
    ldd <span class="s2">"</span><span class="nv">$bin_path</span><span class="s2">"</span> <span class="se">\</span>
    <span class="p">|</span> grep -F -v <span class="s1">'linux-vdso.so'</span> <span class="se">\</span>
    <span class="p">|</span> sed -e <span class="s1">'s/^\(.*=&gt;\)\?\s*//'</span> <span class="se">\</span>
    <span class="p">|</span> sed -e <span class="s1">'s/ (.*$//'</span>
<span class="o">)</span> <span class="p">|</span> tee ./host_path_list.txt
    <span class="c1"># /bin/sh</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libc.so.6</span>
    <span class="c1"># /lib64/ld-linux-x86-64.so.2</span>

<span class="k">while</span> <span class="nb">read</span> -r host_path<span class="p">;</span> <span class="k">do</span>
    cp -fv <span class="s2">"</span><span class="nv">$host_path</span><span class="s2">"</span> .
<span class="k">done</span> &lt; <span class="s2">"host_path_list.txt"</span>

<span class="o">(</span>
    <span class="nb">echo</span> <span class="s1">'FROM scratch'</span>
    <span class="k">while</span> <span class="nb">read</span> -r host_path<span class="p">;</span> <span class="k">do</span>
        <span class="nv">name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">"</span><span class="nv">$host_path</span><span class="s2">"</span><span class="k">)</span>
        <span class="nv">container_path</span><span class="o">=</span><span class="s2">"</span><span class="nv">$host_path</span><span class="s2">"</span>
        <span class="nb">echo</span> <span class="s2">"COPY ./</span><span class="nv">$name</span><span class="s2"> </span><span class="nv">$host_path</span><span class="s2">"</span>
    <span class="k">done</span> &lt; <span class="s2">"host_path_list.txt"</span>
    <span class="nb">echo</span> <span class="s1">'CMD ["/bin/sh"]'</span>
<span class="o">)</span> <span class="p">|</span> tee ./Dockerfile

cat ./Dockerfile
    <span class="c1"># FROM scratch</span>
    <span class="c1"># COPY ./sh /bin/sh</span>
    <span class="c1"># COPY ./libc.so.6 /lib/x86_64-linux-gnu/libc.so.6</span>
    <span class="c1"># COPY ./ld-linux-x86-64.so.2 /lib64/ld-linux-x86-64.so.2</span>
    <span class="c1"># CMD ["/bin/sh"]</span>

docker build -t <span class="s2">"</span><span class="nv">$repository</span><span class="s2">"</span> .

docker run -it <span class="s2">"</span><span class="nv">$repository</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$bin_path</span><span class="s2">"</span>
    <span class="c1"># vagrant@buster:sh$ docker run -it local-sh /bin/sh</span>
    <span class="c1"># # echo *</span>
    <span class="c1"># bin dev etc lib lib64 proc sys</span>
    <span class="c1"># # echo bin/*</span>
    <span class="c1"># bin/sh</span>
    <span class="c1"># # echo etc/*</span>
    <span class="c1"># etc/hostname etc/hosts etc/mtab etc/resolv.conf</span>
    <span class="c1"># # echo lib/*</span>
    <span class="c1"># lib/x86_64-linux-gnu</span>
    <span class="c1"># # echo lib64/*</span>
    <span class="c1"># lib64/ld-linux-x86-64.so.2</span>

cat<span class="o">()</span> <span class="o">{</span>
  <span class="k">while</span> <span class="nb">read</span> -r line<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span><span class="p">;</span> <span class="k">done</span> &lt;<span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="o">}</span>

cat /etc/hostname
cat /etc/hosts
cat /etc/mtab
cat /etc/resolv.conf
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat /etc/hostname</span>
<span class="mi">1</span><span class="n">b6c12d8411e</span>
<span class="c1">#</span>

<span class="c1"># cat /etc/hosts</span>
<span class="mf">127.0.0.1</span>       <span class="n">localhost</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">fe00</span><span class="p">::</span><span class="mi">0</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localnet</span>
<span class="n">ff00</span><span class="p">::</span><span class="mi">0</span> <span class="n">ip6</span><span class="o">-</span><span class="n">mcastprefix</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>
<span class="mf">172.17.0.2</span>      <span class="mi">1</span><span class="n">b6c12d8411e</span>
<span class="c1">#</span>

<span class="c1"># cat /etc/mtab</span>
<span class="n">overlay</span> <span class="o">/</span> <span class="n">overlay</span> <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">lowerdir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">overlay2</span><span class="o">/</span><span class="n">l</span><span class="o">/</span><span class="n">Z44KSU3YCWE7MA64OKWRUNUFD6</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">overlay2</span><span class="o">/</span><span class="n">l</span><span class="o">/</span><span class="n">H2MZ2RGW64DFSUJ74MDJUMQ74V</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">overlay2</span><span class="o">/</span><span class="n">l</span><span class="o">/</span><span class="n">S7XXB6K253N7QG6NESGUNEWTVP</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">overlay2</span><span class="o">/</span><span class="n">l</span><span class="o">/</span><span class="n">YBMFK2HDDU3EPWFU6LPUX4TCML</span><span class="p">,</span><span class="n">upperdir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">overlay2</span><span class="o">/</span><span class="n">c33f2a34f5756566118c334cadd31748a1335e5fbe38c5bd32fde27fcf8d610e</span><span class="o">/</span><span class="n">diff</span><span class="p">,</span><span class="n">workdir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">overlay2</span><span class="o">/</span><span class="n">c33f2a34f5756566118c334cadd31748a1335e5fbe38c5bd32fde27fcf8d610e</span><span class="o">/</span><span class="n">work</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">proc</span> <span class="o">/</span><span class="n">proc</span> <span class="n">proc</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">dev</span> <span class="n">tmpfs</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="n">k</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">755</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">devpts</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">pts</span> <span class="n">devpts</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">gid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">620</span><span class="p">,</span><span class="n">ptmxmode</span><span class="o">=</span><span class="mi">666</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">sysfs</span> <span class="o">/</span><span class="n">sys</span> <span class="n">sysfs</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span> <span class="n">tmpfs</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">755</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">systemd</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">xattr</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">systemd</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">net_cls</span><span class="p">,</span><span class="n">net_prio</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">net_cls</span><span class="p">,</span><span class="n">net_prio</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">perf_event</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">perf_event</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">pids</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">pids</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">devices</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">devices</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">blkio</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">blkio</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">memory</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">memory</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">freezer</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">freezer</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpu</span><span class="p">,</span><span class="n">cpuacct</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">cpu</span><span class="p">,</span><span class="n">cpuacct</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">cpuset</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">cpuset</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">cgroup</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="o">/</span><span class="n">rdma</span> <span class="n">cgroup</span> <span class="n">ro</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">rdma</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">mqueue</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mqueue</span> <span class="n">mqueue</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">shm</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span> <span class="n">tmpfs</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">nodev</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="n">k</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span> <span class="n">ext4</span> <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">discard</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="n">remount</span><span class="o">-</span><span class="n">ro</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hostname</span> <span class="n">ext4</span> <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">discard</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="n">remount</span><span class="o">-</span><span class="n">ro</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span> <span class="n">ext4</span> <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">discard</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="n">remount</span><span class="o">-</span><span class="n">ro</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">devpts</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">console</span> <span class="n">devpts</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">noexec</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">gid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">620</span><span class="p">,</span><span class="n">ptmxmode</span><span class="o">=</span><span class="mi">666</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">proc</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">bus</span> <span class="n">proc</span> <span class="n">ro</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">proc</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">fs</span> <span class="n">proc</span> <span class="n">ro</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">proc</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">irq</span> <span class="n">proc</span> <span class="n">ro</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">proc</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span> <span class="n">proc</span> <span class="n">ro</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">proc</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sysrq</span><span class="o">-</span><span class="n">trigger</span> <span class="n">proc</span> <span class="n">ro</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">acpi</span> <span class="n">tmpfs</span> <span class="n">ro</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">kcore</span> <span class="n">tmpfs</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="n">k</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">755</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">keys</span> <span class="n">tmpfs</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="n">k</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">755</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">timer_list</span> <span class="n">tmpfs</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="n">k</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">755</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sched_debug</span> <span class="n">tmpfs</span> <span class="n">rw</span><span class="p">,</span><span class="n">nosuid</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="n">k</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">755</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="n">tmpfs</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">firmware</span> <span class="n">tmpfs</span> <span class="n">ro</span><span class="p">,</span><span class="n">relatime</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="c1">#</span>

<span class="c1"># cat /etc/resolv.conf</span>
<span class="n">nameserver</span> <span class="mf">10.0.2.3</span>
<span class="c1">#</span>
</pre></div>
</div>
</section>
<section id="find">
<h5>find を動かせるようにする<a class="headerlink" href="#find" title="このヘッドラインへのパーマリンク">¶</a></h5>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">bin_path</span><span class="o">=</span>/usr/bin/find
<span class="nv">repository</span><span class="o">=</span>local-scrach-find

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/sh"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

ldd <span class="s2">"</span><span class="nv">$bin_path</span><span class="s2">"</span>

<span class="o">(</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$bin_path</span><span class="s2">"</span>
    ldd <span class="s2">"</span><span class="nv">$bin_path</span><span class="s2">"</span> <span class="se">\</span>
    <span class="p">|</span> grep -F -v <span class="s1">'linux-vdso.so'</span> <span class="se">\</span>
    <span class="p">|</span> sed -e <span class="s1">'s/^\(.*=&gt;\)\?\s*//'</span> <span class="se">\</span>
    <span class="p">|</span> sed -e <span class="s1">'s/ (.*$//'</span>
<span class="o">)</span> <span class="p">|</span> tee ./host_path_list.txt

<span class="k">while</span> <span class="nb">read</span> -r host_path<span class="p">;</span> <span class="k">do</span>
    cp -fv <span class="s2">"</span><span class="nv">$host_path</span><span class="s2">"</span> .
<span class="k">done</span> &lt; <span class="s2">"host_path_list.txt"</span>
    <span class="c1"># /usr/bin/find</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libselinux.so.1</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libm.so.6</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libc.so.6</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libpcre.so.3</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libdl.so.2</span>
    <span class="c1"># /lib64/ld-linux-x86-64.so.2</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libpthread.so.0</span>

<span class="o">(</span>
    <span class="nb">echo</span> <span class="s1">'FROM scratch'</span>
    <span class="k">while</span> <span class="nb">read</span> -r host_path<span class="p">;</span> <span class="k">do</span>
        <span class="nv">name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">"</span><span class="nv">$host_path</span><span class="s2">"</span><span class="k">)</span>
        <span class="nv">container_path</span><span class="o">=</span><span class="s2">"</span><span class="nv">$host_path</span><span class="s2">"</span>
        <span class="nb">echo</span> <span class="s2">"COPY ./</span><span class="nv">$name</span><span class="s2"> </span><span class="nv">$host_path</span><span class="s2">"</span>
    <span class="k">done</span> &lt; <span class="s2">"host_path_list.txt"</span>
    <span class="nb">echo</span> <span class="s1">'CMD ["/bin/sh"]'</span>
<span class="o">)</span> <span class="p">|</span> tee ./Dockerfile

cat ./Dockerfile

docker build -t <span class="s2">"</span><span class="nv">$repository</span><span class="s2">"</span> .

docker run -it <span class="s2">"</span><span class="nv">$repository</span><span class="s2">"</span> <span class="s2">"/usr/bin/find"</span> --version
docker run -it <span class="s2">"</span><span class="nv">$repository</span><span class="s2">"</span> <span class="s2">"/usr/bin/find"</span> / -type f &gt;find.txt
grep -v -e ^/dev -e ^/proc -e ^/sys ./find.txt
    <span class="c1"># /usr/bin/find</span>
    <span class="c1"># /etc/hosts</span>
    <span class="c1"># /etc/resolv.conf</span>
    <span class="c1"># /etc/hostname</span>
    <span class="c1"># /.dockerenv</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libselinux.so.1</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libpthread.so.0</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libdl.so.2</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libpcre.so.3</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libc.so.6</span>
    <span class="c1"># /lib/x86_64-linux-gnu/libm.so.6</span>
    <span class="c1"># /lib64/ld-linux-x86-64.so.2</span>
</pre></div>
</div>
<p>ちなみに、イメージの名前 scratch は予約されている。
scrach イメージの pull, run, inspect もできない。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker image pull scratch
Using default tag: latest
Error response from daemon: <span class="s1">'scratch'</span> is a reserved name

vagrant@buster:~$ docker run -it scratch /bin/sh
Unable to find image <span class="s1">'scratch:latest'</span> locally
docker: Error response from daemon: <span class="s1">'scratch'</span> is a reserved name.
See <span class="s1">'docker run --help'</span>.

vagrant@buster:~$ docker inspect scratch
<span class="o">[]</span>
Error: No such object: scratch
</pre></div>
</div>
<p>参考資料</p>
<ul class="simple">
<li><p>https://hub.docker.com/_/hello-world</p></li>
<li><p>https://github.com/docker-library/hello-world/tree/master/amd64/hello-world</p></li>
<li><p>https://dev.classmethod.jp/articles/exploration-to-docker-scratch/</p></li>
</ul>
</section>
</section>
</section>
<section id="debian-buster">
<h3>debian:buster コンテナのイメージ<a class="headerlink" href="#debian-buster" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="id43">
<h4>ディレクトリ数、ファイル数を確認する<a class="headerlink" href="#id43" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it debian:buster /usr/bin/find -type d <span class="p">|</span> wc -l
docker run -it debian:buster /usr/bin/find -type f <span class="p">|</span> wc -l
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker run -it debian:buster /usr/bin/find -type d | wc -l
2301
vagrant@buster:~$ docker run -it debian:buster /usr/bin/find -type f | wc -l
17326
</pre></div>
</div>
</section>
<section id="ps">
<h4>ps コマンドを実行する<a class="headerlink" href="#ps" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it debian:buster bash

<span class="c1"># ps コマンドは入ってないので入れる</span>
apt update
apt install apt-file -y
apt-file update
apt-file search /bin/ps <span class="p">|</span> grep <span class="s2">"/ps</span>$<span class="s2">"</span>
apt install -y procps

ps -ef
    <span class="c1"># root@6f891debfcfe:/# ps -e</span>
    <span class="c1">#   PID TTY          TIME CMD</span>
    <span class="c1">#     1 pts/0    00:00:00 bash</span>
    <span class="c1">#  1003 pts/0    00:00:00 ps</span>
</pre></div>
</div>
</section>
<section id="id44">
<h4>指定パッケージをインストールしたコンテナのイメージを作る<a class="headerlink" href="#id44" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">name_tag</span><span class="o">=</span><span class="s2">"local-debian-ps"</span>

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/tmp-</span><span class="si">${</span><span class="nv">name_tag</span><span class="si">}</span><span class="s2">"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee ./Dockerfile</span>
<span class="s">FROM debian:buster</span>
<span class="s">ENV DEBCONF_NOWARNINGS yes</span>
<span class="s">RUN apt-get update \</span>
<span class="s">  &amp;&amp; apt-get install -y procps</span>
<span class="s">__DOCKERFILE__</span>

docker build -t <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> .

docker run -it <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> /bin/ps -e
    <span class="c1">#   PID TTY          TIME CMD</span>
    <span class="c1">#     1 pts/0    00:00:00 ps</span>
</pre></div>
</div>
</section>
</section>
<section id="centos-centos8">
<h3>centos:centos8 コンテナのイメージ<a class="headerlink" href="#centos-centos8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="id45">
<h4>ディレクトリ数、ファイル数を確認する<a class="headerlink" href="#id45" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it centos:centos8 /usr/bin/find -type d <span class="p">|</span> wc -l
docker run -it centos:centos8 /usr/bin/find -type f <span class="p">|</span> wc -l
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[vagrant@localhost ~]$ docker run -it centos:centos8 /usr/bin/find -type d | wc -l
2796
[vagrant@localhost ~]$ docker run -it centos:centos8 /usr/bin/find -type f | wc -l
18383
</pre></div>
</div>
</section>
<section id="curl">
<h4>curl コマンドを実行する<a class="headerlink" href="#curl" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it centos:centos8 bash

<span class="c1"># curl コマンドは入ってないので入れる</span>
dnf provides /usr/bin/curl
dnf install curl -y

curl -s https://www.example.com/ <span class="p">|</span> grep h1
    <span class="c1"># --&gt; &lt;h1&gt;Example Domain&lt;/h1&gt;</span>
</pre></div>
</div>
</section>
<section id="id46">
<h4>指定パッケージをインストールしたコンテナのイメージを作る<a class="headerlink" href="#id46" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">name_tag</span><span class="o">=</span><span class="s2">"local-centos8-python36"</span>

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/tmp-</span><span class="si">${</span><span class="nv">name_tag</span><span class="si">}</span><span class="s2">"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee ./Dockerfile</span>
<span class="s">FROM centos:centos8</span>
<span class="s">RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial \</span>
<span class="s">RUN dnf update -y \</span>
<span class="s">  &amp;&amp; dnf install -y python36 \</span>
<span class="s">  &amp;&amp; dnf clean all</span>
<span class="s">__DOCKERFILE__</span>

docker build -t <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> .

docker run -it <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> /usr/bin/python3
</pre></div>
</div>
</section>
</section>
<section id="nicolaka-netshoot">
<h3>nicolaka/netshoot コンテナのイメージ<a class="headerlink" href="#nicolaka-netshoot" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="id47">
<h4>ホスト名を解決する<a class="headerlink" href="#id47" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>エイリアス mysql の名前解決を試みる。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it --network todo-app nicolaka/netshoot
dig mysql
</pre></div>
</div>
</section>
</section>
<section id="alpine">
<h3>alpine コンテナのイメージ<a class="headerlink" href="#alpine" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="id48">
<h4>ディレクトリ数、ファイル数を確認する<a class="headerlink" href="#id48" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it alpine /usr/bin/find -type d <span class="p">|</span> wc -l
docker run -it alpine /usr/bin/find -type f <span class="p">|</span> wc -l
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker run -it alpine /usr/bin/find -type d | wc -l
1630
vagrant@buster:~$ docker run -it alpine /usr/bin/find -type f | wc -l
12208
</pre></div>
</div>
</section>
<section id="id49">
<h4>指定パッケージをインストールしたコンテナのイメージを作る<a class="headerlink" href="#id49" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>https://pkgs.alpinelinux.org/contents で <code class="docutils literal notranslate"><span class="pre">dig</span></code> を探す。
bind-utils が必要であるとわかる。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">name_tag</span><span class="o">=</span><span class="s2">"local-alpine-dig"</span>

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/tmp-</span><span class="si">${</span><span class="nv">name_tag</span><span class="si">}</span><span class="s2">"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee ./Dockerfile</span>
<span class="s">FROM alpine</span>
<span class="s">RUN apk update \</span>
<span class="s">  &amp;&amp; apk add bind-tools</span>
<span class="s">__DOCKERFILE__</span>

docker build -t <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> .

docker run -it <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> dig -v
  <span class="c1"># vagrant@buster:/tmp/tmp.A0SmxClT0A/tmp-local-alpine-dig$ docker run -it "$name_tag" dig -v</span>
  <span class="c1"># DiG 9.16.11</span>
</pre></div>
</div>
</section>
</section>
<section id="distroless">
<h3>distroless コンテナのイメージ<a class="headerlink" href="#distroless" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="todo">
<h4>todo<a class="headerlink" href="#todo" title="このヘッドラインへのパーマリンク">¶</a></h4>
</section>
</section>
</section>
<section id="id50">
<h2>レジストリ<a class="headerlink" href="#id50" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id51">
<h3>レジストリの種類<a class="headerlink" href="#id51" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Docker Hub</p></li>
<li><p>ローカルの Docker レジストリ</p></li>
</ul>
</section>
<section id="id52">
<h3>ローカルのレジストリを起動する<a class="headerlink" href="#id52" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>https://hub.docker.com/_/registry</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -d -p <span class="m">5000</span>:5000 --restart<span class="o">=</span>always --name registry registry:2

<span class="c1"># ローカルでレジストリを起動する</span>
docker logs registry
    <span class="c1"># vagrant@buster:~$ docker logs registry</span>
    <span class="c1"># time="2021-04-14T12:24:57.577635365Z" level=warning msg="No HTTP secret provided - generated random secret. This may cause problems with uploads if multiple registries are behind a load-balancer. To provide a shared secret, fill in http.secret in the configuration file or set the REGISTRY_HTTP_SECRET environment variable." go.version=go1.11.2 instance.id=10c5dcfc-022f-4036-8047-95753999ead8 service=registry version=v2.7.1</span>
    <span class="c1"># time="2021-04-14T12:24:57.578139382Z" level=info msg="redis not configured" go.version=go1.11.2 instance.id=10c5dcfc-022f-4036-8047-95753999ead8 service=registry version=v2.7.1</span>
    <span class="c1"># time="2021-04-14T12:24:57.578980882Z" level=info msg="Starting upload purge in 44m0s" go.version=go1.11.2 instance.id=10c5dcfc-022f-4036-8047-95753999ead8 service=registry version=v2.7.1</span>
    <span class="c1"># time="2021-04-14T12:24:57.594343252Z" level=info msg="using inmemory blob descriptor cache" go.version=go1.11.2 instance.id=10c5dcfc-022f-4036-8047-95753999ead8 service=registry version=v2.7.1</span>
    <span class="c1"># time="2021-04-14T12:24:57.594686701Z" level=info msg="listening on [::]:5000" go.version=go1.11.2 instance.id=10c5dcfc-022f-4036-8047-95753999ead8 service=registry version=v2.7.1</span>
</pre></div>
</div>
<p>https://docs.docker.com/registry/deploying/
https://docs.docker.com/registry/configuration/</p>
</section>
<section id="id53">
<h3>ローカルのレジストリを終了する<a class="headerlink" href="#id53" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker stop registry
</pre></div>
</div>
</section>
<section id="id54">
<h3>ローカルのレジストリを消す<a class="headerlink" href="#id54" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker container rm -v registry
    <span class="c1"># vagrant@buster:~$ docker container rm -v registry</span>
    <span class="c1"># registry</span>
</pre></div>
</div>
</section>
<section id="id55">
<h3>ローカルのレジストリのストレージにホストの指定パスを指定する<a class="headerlink" href="#id55" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ホストの /mnt/registry をコンテナ内の /var/lib/registry にする</span>
<span class="nv">host_dir</span><span class="o">=</span><span class="s2">"/mnt/registry"</span>

sudo mkdir -pv <span class="s2">"</span><span class="nv">$host_dir</span><span class="s2">"</span>
ls -al /mnt/registry

docker run -d <span class="se">\</span>
  -p <span class="m">5000</span>:5000 <span class="se">\</span>
  --restart<span class="o">=</span>always <span class="se">\</span>
  --name registry <span class="se">\</span>
  -v <span class="s2">"</span><span class="nv">$host_dir</span><span class="s2">:/var/lib/registry"</span> <span class="se">\</span>
  registry:2
</pre></div>
</div>
</section>
<section id="id56">
<h3>ローカルレジストリを削除有効にして起動する<a class="headerlink" href="#id56" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ホストの /mnt/registry をコンテナ内の /var/lib/registry にする</span>
<span class="nv">host_dir</span><span class="o">=</span><span class="s2">"/mnt/registry"</span>

sudo rm -frv <span class="s2">"</span><span class="nv">$host_dir</span><span class="s2">"</span>
docker container stop registry
docker container rm -v registry

sudo mkdir -pv <span class="s2">"</span><span class="nv">$host_dir</span><span class="s2">"</span>
ls -al /mnt/registry

docker run -d <span class="se">\</span>
  -p <span class="m">5000</span>:5000 <span class="se">\</span>
  --restart<span class="o">=</span>always <span class="se">\</span>
  --name registry <span class="se">\</span>
  -v <span class="s2">"</span><span class="nv">$host_dir</span><span class="s2">:/var/lib/registry"</span> <span class="se">\</span>
  -e <span class="nv">REGISTRY_STORAGE_DELETE_ENABLED</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  registry:2
</pre></div>
</div>
</section>
<section id="id57">
<h3>ローカルのレジストリのストレージ用のドライバを調べる<a class="headerlink" href="#id57" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>https://docs.docker.com/registry/storage-drivers/</p>
<p>filesystem, s3, azure, swift, gcs など。</p>
</section>
<section id="id58">
<h3>レジストリのイメージの一覧を得る<a class="headerlink" href="#id58" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -X GET http://localhost:5000/v2/_catalog
    <span class="c1"># vagrant@buster:~$ curl -X GET http://localhost:5000/v2/_catalog</span>
    <span class="c1"># {"repositories":["my-ubuntu"]}</span>
</pre></div>
</div>
</section>
<section id="id59">
<h3>レジストリの指定イメージのタグ一覧を得る<a class="headerlink" href="#id59" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -X GET http://localhost:5000/v2/my-ubuntu/tags/list
    <span class="c1"># vagrant@buster:~$ curl -X GET http://localhost:5000/v2/my-ubuntu/tags/list</span>
    <span class="c1"># {"name":"my-ubuntu","tags":["latest"]}</span>
</pre></div>
</div>
</section>
<section id="id60">
<h3>レジストリにイメージを加える<a class="headerlink" href="#id60" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># インターネットから、ローカルにイメージを pull する</span>
docker pull ubuntu:16.04
    <span class="c1"># vagrant@buster:~$ docker pull ubuntu:16.04</span>
    <span class="c1"># 16.04: Pulling from library/ubuntu</span>
    <span class="c1"># 4007a89234b4: Pull complete</span>
    <span class="c1"># c1de0f9cdfc1: Pull complete</span>
    <span class="c1"># c8ee6ca703b8: Pull complete</span>
    <span class="c1"># b39e2761d3d4: Pull complete</span>
    <span class="c1"># Digest: sha256:bb84bbf2ff36d46acaf0bb0c6bcb33dae64cd93cba8652d74c9aaf438fada438</span>
    <span class="c1"># Status: Downloaded newer image for ubuntu:16.04</span>
    <span class="c1"># docker.io/library/ubuntu:16.04</span>

<span class="c1"># pull したイメージにタグをつける</span>
docker tag ubuntu:16.04 localhost:5000/my-ubuntu

docker image ls <span class="p">|</span> grep -e ^REPO -e ubuntu
    <span class="c1"># vagrant@buster:~$ docker image ls | grep -e ^REPO -e ubuntu</span>
    <span class="c1"># REPOSITORY                 TAG       IMAGE ID       CREATED        SIZE</span>
    <span class="c1"># ubuntu                     16.04     f6f49faac5cf   2 weeks ago    132MB</span>
    <span class="c1"># localhost:5000/my-ubuntu   latest    f6f49faac5cf   2 weeks ago    132MB</span>

<span class="c1"># タグをつけたイメージをローカルのレジストリに push する</span>
docker push localhost:5000/my-ubuntu
    <span class="c1"># vagrant@buster:~$ docker push localhost:5000/my-ubuntu</span>
    <span class="c1"># Using default tag: latest</span>
    <span class="c1"># The push refers to repository [localhost:5000/my-ubuntu]</span>
    <span class="c1"># 7b664579ad4c: Pushed</span>
    <span class="c1"># 511cdf594715: Pushed</span>
    <span class="c1"># 46e1f2649e2a: Pushed</span>
    <span class="c1"># 935c56d8b3f9: Pushed</span>
    <span class="c1"># latest: digest: sha256:8cfb8f14fbeb9d44174209ccda485e0bfacc910d5624faac8cc876f5c1376781 size: 1150</span>
</pre></div>
</div>
</section>
<section id="pull">
<h3>レジストリを指定して pull する<a class="headerlink" href="#pull" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ローカルのイメージを消す</span>
docker image remove ubuntu:16.04
    <span class="c1"># vagrant@buster:~$ docker image remove ubuntu:16.04</span>
    <span class="c1"># Untagged: ubuntu:16.04</span>
    <span class="c1"># Untagged: ubuntu@sha256:bb84bbf2ff36d46acaf0bb0c6bcb33dae64cd93cba8652d74c9aaf438fada438</span>

<span class="c1"># ローカルのイメージを消す</span>
docker image remove localhost:5000/my-ubuntu
    <span class="c1"># vagrant@buster:~$ docker image remove localhost:5000/my-ubuntu</span>
    <span class="c1"># Untagged: localhost:5000/my-ubuntu:latest</span>
    <span class="c1"># Untagged: localhost:5000/my-ubuntu@sha256:8cfb8f14fbeb9d44174209ccda485e0bfacc910d5624faac8cc876f5c1376781</span>
    <span class="c1"># Deleted: sha256:f6f49faac5cf9e9589f3c34821ba2d36fd093e7eb52d5b6cd000ea3dae3698df</span>
    <span class="c1"># Deleted: sha256:5abd36dd4be8e675b62f5ff5d279e6fd0dc09f2f21b1a930bf7f90f92b76a4e2</span>
    <span class="c1"># Deleted: sha256:6abaaf48a3f215b6c48990f422e15dd15bdf2b29c935cb03fbefc7b9f47adfe0</span>
    <span class="c1"># Deleted: sha256:3bf034b6a7ee8efe9555a5d3bc283cdad6d638706468448cccbf8a648881e380</span>
    <span class="c1"># Deleted: sha256:935c56d8b3f96d6587f3640e491767688b790c458a01fef327188abcbbafdc9a</span>

<span class="c1"># ローカルのレジストリからイメージを pull する</span>
docker pull localhost:5000/my-ubuntu
    <span class="c1"># vagrant@buster:~$ docker pull localhost:5000/my-ubuntu</span>
    <span class="c1"># Using default tag: latest</span>
    <span class="c1"># latest: Pulling from my-ubuntu</span>
    <span class="c1"># 4007a89234b4: Pull complete</span>
    <span class="c1"># c1de0f9cdfc1: Pull complete</span>
    <span class="c1"># c8ee6ca703b8: Pull complete</span>
    <span class="c1"># b39e2761d3d4: Pull complete</span>
    <span class="c1"># Digest: sha256:8cfb8f14fbeb9d44174209ccda485e0bfacc910d5624faac8cc876f5c1376781</span>
    <span class="c1"># Status: Downloaded newer image for localhost:5000/my-ubuntu:latest</span>
    <span class="c1"># localhost:5000/my-ubuntu:latest</span>
</pre></div>
</div>
</section>
<section id="id61">
<h3>レジストリからイメージを消す<a class="headerlink" href="#id61" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -X GET http://localhost:5000/v2/my-ubuntu/manifests/latest
    <span class="c1"># vagrant@buster:~$ curl -X GET http://localhost:5000/v2/my-ubuntu/manifests/latest</span>
    <span class="c1"># {</span>
    <span class="c1">#    "schemaVersion": 1,</span>
    <span class="c1">#    "name": "my-ubuntu",</span>
    <span class="c1">#    "tag": "latest",</span>
    <span class="c1">#    "architecture": "amd64",</span>
    <span class="c1">#    "fsLayers": [</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "blobSum": "sha256:b39e2761d3d4971e78914857af4c6bd9989873b53426cf2fef3e76983b166fa2"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "blobSum": "sha256:c8ee6ca703b866ac2b74b6129d2db331936292f899e8e3a794474fdf81343605"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "blobSum": "sha256:c1de0f9cdfc1f9f595acd2ea8724ea92a509d64a6936f0e645c65b504e7e4bc6"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "blobSum": "sha256:4007a89234b4f56c03e6831dc220550d2e5fba935d9f5f5bcea64857ac4f4888"</span>
    <span class="c1">#       }</span>
    <span class="c1">#    ],</span>
    <span class="c1">#    "history": [</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "v1Compatibility": "{\"architecture\":\"amd64\",\"config\":{\"Hostname\":\"\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/bash\"],\"Image\":\"sha256:d2ecd652988e90d0864c815b7b44ea9893dbe340670329d7a49734490ee1bb70\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":null},\"container\":\"58a42851b95b72b9568746722d7394a21564c14b074e58ff8522bf6be8900d01\",\"container_config\":{\"Hostname\":\"58a42851b95b\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/sh\",\"-c\",\"#(nop) \",\"CMD [\\\"/bin/bash\\\"]\"],\"Image\":\"sha256:d2ecd652988e90d0864c815b7b44ea9893dbe340670329d7a49734490ee1bb70\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":{}},\"created\":\"2021-03-25T22:33:55.391277586Z\",\"docker_version\":\"19.03.12\",\"id\":\"87c8cf461fff93d2caafa8f0d57c41b5812d3e767e248ccfc2d611d78135caa7\",\"os\":\"linux\",\"parent\":\"2f3d057b8c442714c4faaadf47a76c473524fe5d01247a0fc5fdc01f2f9948ac\",\"throwaway\":true}"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "v1Compatibility": "{\"id\":\"2f3d057b8c442714c4faaadf47a76c473524fe5d01247a0fc5fdc01f2f9948ac\",\"parent\":\"87c25acfbe99051e1fb6ad726dffd5c00cec8780f6088d67128021ab912e81c8\",\"created\":\"2021-03-25T22:33:55.207583169Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c mkdir -p /run/systemd \\u0026\\u0026 echo 'docker' \\u003e /run/systemd/container\"]}}"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "v1Compatibility": "{\"id\":\"87c25acfbe99051e1fb6ad726dffd5c00cec8780f6088d67128021ab912e81c8\",\"parent\":\"d795159f9aaaf334adf8cc6ac7ed7dc3cae2cd40e578b882f5a9aead51f024e7\",\"created\":\"2021-03-25T22:33:54.285001153Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c rm -rf /var/lib/apt/lists/*\"]}}"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "v1Compatibility": "{\"id\":\"d795159f9aaaf334adf8cc6ac7ed7dc3cae2cd40e578b882f5a9aead51f024e7\",\"parent\":\"eb1bcec49480a3c7604c1f5d28d8ae0fb27fce84002e999b86563eb496330f42\",\"created\":\"2021-03-25T22:33:53.308246479Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c set -xe \\t\\t\\u0026\\u0026 echo '#!/bin/sh' \\u003e /usr/sbin/policy-rc.d \\t\\u0026\\u0026 echo 'exit 101' \\u003e\\u003e /usr/sbin/policy-rc.d \\t\\u0026\\u0026 chmod +x /usr/sbin/policy-rc.d \\t\\t\\u0026\\u0026 dpkg-divert --local --rename --add /sbin/initctl \\t\\u0026\\u0026 cp -a /usr/sbin/policy-rc.d /sbin/initctl \\t\\u0026\\u0026 sed -i 's/^exit.*/exit 0/' /sbin/initctl \\t\\t\\u0026\\u0026 echo 'force-unsafe-io' \\u003e /etc/dpkg/dpkg.cfg.d/docker-apt-speedup \\t\\t\\u0026\\u0026 echo 'DPkg::Post-Invoke { \\\"rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\\\"; };' \\u003e /etc/apt/apt.conf.d/docker-clean \\t\\u0026\\u0026 echo 'APT::Update::Post-Invoke { \\\"rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\\\"; };' \\u003e\\u003e /etc/apt/apt.conf.d/docker-clean \\t\\u0026\\u0026 echo 'Dir::Cache::pkgcache \\\"\\\"; Dir::Cache::srcpkgcache \\\"\\\";' \\u003e\\u003e /etc/apt/apt.conf.d/docker-clean \\t\\t\\u0026\\u0026 echo 'Acquire::Languages \\\"none\\\";' \\u003e /etc/apt/apt.conf.d/docker-no-languages \\t\\t\\u0026\\u0026 echo 'Acquire::GzipIndexes \\\"true\\\"; Acquire::CompressionTypes::Order:: \\\"gz\\\";' \\u003e /etc/apt/apt.conf.d/docker-gzip-indexes \\t\\t\\u0026\\u0026 echo 'Apt::AutoRemove::SuggestsImportant \\\"false\\\";' \\u003e /etc/apt/apt.conf.d/docker-autoremove-suggests\"]}}"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "v1Compatibility": "{\"id\":\"eb1bcec49480a3c7604c1f5d28d8ae0fb27fce84002e999b86563eb496330f42\",\"created\":\"2021-03-25T22:33:52.163561628Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) ADD file:925571658dd8453e5c80d862f5791d6b26b3c2a8688937b11741f2f2c5cdbfd7 in / \"]}}"</span>
    <span class="c1">#       }</span>
    <span class="c1">#    ],</span>
    <span class="c1">#    "signatures": [</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "header": {</span>
    <span class="c1">#             "jwk": {</span>
    <span class="c1">#                "crv": "P-256",</span>
    <span class="c1">#                "kid": "LREZ:6NXK:DW2C:BZYX:YAXA:NY65:EB6Z:XPLN:UZMV:P2IS:S4CT:VQ3W",</span>
    <span class="c1">#                "kty": "EC",</span>
    <span class="c1">#                "x": "G9XJ6W6K2dhsjQwPM5BK8FAFeOpa28kTCiWI5unkPcs",</span>
    <span class="c1">#                "y": "AZIYfB38wQbPHyCRCHAcvr3QJtKWW6GBE1IX4Tx3uEc"</span>
    <span class="c1">#             },</span>
    <span class="c1">#             "alg": "ES256"</span>
    <span class="c1">#          },</span>
    <span class="c1">#          "signature": "BOovoidxxChzBeWdynNccZAjQxHPHQEj_rIclLj1TemOIOwsGdPt9qR2b0CQpMMzoLNgfsr7mZCAKGRDfjOPmA",</span>
    <span class="c1">#          "protected": "eyJmb3JtYXRMZW5ndGgiOjQ4NzMsImZvcm1hdFRhaWwiOiJDbjAiLCJ0aW1lIjoiMjAyMS0wNC0xNFQxMzo1NDo0OFoifQ"</span>
    <span class="c1">#       }</span>
    <span class="c1">#    ]</span>
    <span class="c1"># }</span>

<span class="c1"># schema のバージョン 2 対応で、進捗は表示せず、レスポンスヘッダを得る</span>
curl -i -s -H <span class="s2">"Accept: application/vnd.docker.distribution.manifest.v2+json"</span> http://localhost:5000/v2/my-ubuntu/manifests/latest
    <span class="c1"># vagrant@buster:~$ curl -i -H "Accept: application/vnd.docker.distribution.manifest.v2+json" http://localhost:5000/v2/my-ubuntu/manifests/latest</span>
    <span class="c1"># HTTP/1.1 200 OK</span>
    <span class="c1"># Content-Length: 1150</span>
    <span class="c1"># Content-Type: application/vnd.docker.distribution.manifest.v2+json</span>
    <span class="c1"># Docker-Content-Digest: sha256:8cfb8f14fbeb9d44174209ccda485e0bfacc910d5624faac8cc876f5c1376781</span>
    <span class="c1"># Docker-Distribution-Api-Version: registry/2.0</span>
    <span class="c1"># Etag: "sha256:8cfb8f14fbeb9d44174209ccda485e0bfacc910d5624faac8cc876f5c1376781"</span>
    <span class="c1"># X-Content-Type-Options: nosniff</span>
    <span class="c1"># Date: Wed, 14 Apr 2021 13:58:32 GMT</span>
    <span class="c1">#</span>
    <span class="c1"># {</span>
    <span class="c1">#    "schemaVersion": 2,</span>
    <span class="c1">#    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",</span>
    <span class="c1">#    "config": {</span>
    <span class="c1">#       "mediaType": "application/vnd.docker.container.image.v1+json",</span>
    <span class="c1">#       "size": 3364,</span>
    <span class="c1">#       "digest": "sha256:f6f49faac5cf9e9589f3c34821ba2d36fd093e7eb52d5b6cd000ea3dae3698df"</span>
    <span class="c1">#    },</span>
    <span class="c1">#    "layers": [</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span>
    <span class="c1">#          "size": 45962352,</span>
    <span class="c1">#          "digest": "sha256:4007a89234b4f56c03e6831dc220550d2e5fba935d9f5f5bcea64857ac4f4888"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span>
    <span class="c1">#          "size": 846,</span>
    <span class="c1">#          "digest": "sha256:c1de0f9cdfc1f9f595acd2ea8724ea92a509d64a6936f0e645c65b504e7e4bc6"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span>
    <span class="c1">#          "size": 526,</span>
    <span class="c1">#          "digest": "sha256:c8ee6ca703b866ac2b74b6129d2db331936292f899e8e3a794474fdf81343605"</span>
    <span class="c1">#       },</span>
    <span class="c1">#       {</span>
    <span class="c1">#          "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span>
    <span class="c1">#          "size": 168,</span>
    <span class="c1">#          "digest": "sha256:b39e2761d3d4971e78914857af4c6bd9989873b53426cf2fef3e76983b166fa2"</span>
    <span class="c1">#       }</span>
    <span class="c1">#    ]</span>
    <span class="c1"># }</span>

<span class="c1"># digest を得る</span>
<span class="nv">docker_content_digest</span><span class="o">=</span><span class="k">$(</span>
    curl -H <span class="s2">"Accept: application/vnd.docker.distribution.manifest.v2+json"</span> -is <span class="se">\</span>
        http://localhost:5000/v2/my-ubuntu/manifests/latest <span class="se">\</span>
    <span class="p">|</span> grep ^Docker-Content-Digest <span class="se">\</span>
    <span class="p">|</span> grep -Po <span class="s1">'(?&lt;=^Docker-Content-Digest: )sha256:\S+'</span>
<span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$docker_content_digest</span><span class="s2">"</span>
    <span class="c1"># sha256:8cfb8f14fbeb9d44174209ccda485e0bfacc910d5624faac8cc876f5c1376781</span>

<span class="c1"># digest をキーにイメージを消す</span>
curl -X DELETE <span class="s2">"http://localhost:5000/v2/my-ubuntu/manifests/</span><span class="nv">$docker_content_digest</span><span class="s2">"</span>

<span class="c1"># イメージをpull できなくなる</span>
docker pull localhost:5000/my-ubuntu
    <span class="c1"># vagrant@buster:~$ docker pull localhost:5000/my-ubuntu</span>
    <span class="c1"># Using default tag: latest</span>
    <span class="c1"># Error response from daemon: manifest for localhost:5000/my-ubuntu:latest not found: manifest unknown: manifest unknown</span>
</pre></div>
</div>
<p>https://qiita.com/Gin/items/c58c4485caae1c139e8f</p>
</section>
</section>
<section id="id62">
<h2>調査、トラブルシュート<a class="headerlink" href="#id62" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id63">
<h3>インタラクティブなシェルを利用できるようにする<a class="headerlink" href="#id63" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>scrach コンテナイメージを参照。</p>
</section>
<section id="id64">
<h3>ネットワーク構成<a class="headerlink" href="#id64" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="ip">
<h4>コンテナと、コンテナホストのIPネットワークを確認する<a class="headerlink" href="#ip" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ip a

cat /etc/resolv.conf
  <span class="c1"># nameserver 10.0.2.3</span>
<span class="nb">read</span> -r _ ns &lt;/etc/resolv.conf
ping -c <span class="m">3</span> <span class="s2">"</span><span class="nv">$ns</span><span class="s2">"</span>
ping -c <span class="m">3</span> www.example.com

docker network ls
<span class="nv">nid</span><span class="o">=</span><span class="k">$(</span>docker network ls --filter <span class="s2">"name=bridge"</span> --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$nid</span><span class="s2">"</span>
docker network inspect <span class="s2">"</span><span class="nv">$nid</span><span class="s2">"</span>

docker run -it debian:buster bash
ip a
ip r
cat /etc/resolv.conf
  <span class="c1"># nameserver 10.0.2.3</span>
<span class="nb">read</span> -r _ ns &lt;/etc/resolv.conf
ping -c <span class="m">3</span> <span class="s2">"</span><span class="nv">$ns</span><span class="s2">"</span>
ping -c <span class="m">3</span> www.example.com
<span class="nb">exit</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Internet</span>
    <span class="o">|</span>
    <span class="p">:</span>
    <span class="o">|</span>
   <span class="o">-</span><span class="n">o</span><span class="o">-------</span><span class="n">o</span><span class="o">-------</span><span class="n">o</span><span class="o">-</span>
            <span class="o">|</span>       <span class="o">|</span>
          <span class="n">router</span>  <span class="n">VM</span> <span class="n">host</span>
            <span class="o">|</span>
           <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="n">o</span><span class="o">-</span> <span class="mf">10.0.2.0</span><span class="o">/</span><span class="mi">24</span>
              <span class="o">|</span>
            <span class="n">Docker</span> <span class="n">Host</span>
            <span class="n">VM</span><span class="p">:</span> <span class="n">buster</span>
              <span class="o">|</span>
             <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="n">o</span><span class="o">---------</span> <span class="mf">172.17.0.1</span><span class="o">/</span><span class="mi">16</span> <span class="p">(</span><span class="n">bridge</span><span class="p">)</span>
                <span class="o">|</span>
                <span class="n">container</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="o">@</span><span class="mi">686046</span><span class="n">d8d374</span><span class="p">:</span><span class="o">/</span><span class="c1"># ip a</span>
<span class="mi">1</span><span class="p">:</span> <span class="n">lo</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">LOOPBACK</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">65536</span> <span class="n">qdisc</span> <span class="n">noqueue</span> <span class="n">state</span> <span class="n">UNKNOWN</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">loopback</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">brd</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">inet</span> <span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">8</span> <span class="n">scope</span> <span class="n">host</span> <span class="n">lo</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
<span class="mi">50</span><span class="p">:</span> <span class="n">eth0</span><span class="nd">@if51</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">noqueue</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">group</span> <span class="n">default</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="mi">02</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="n">ac</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">03</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">link</span><span class="o">-</span><span class="n">netnsid</span> <span class="mi">0</span>
    <span class="n">inet</span> <span class="mf">172.17.0.3</span><span class="o">/</span><span class="mi">16</span> <span class="n">brd</span> <span class="mf">172.17.255.255</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">eth0</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="o">@</span><span class="mi">686046</span><span class="n">d8d374</span><span class="p">:</span><span class="o">/</span><span class="c1"># ip r</span>
<span class="n">default</span> <span class="n">via</span> <span class="mf">172.17.0.1</span> <span class="n">dev</span> <span class="n">eth0</span>
<span class="mf">172.17.0.0</span><span class="o">/</span><span class="mi">16</span> <span class="n">dev</span> <span class="n">eth0</span> <span class="n">proto</span> <span class="n">kernel</span> <span class="n">scope</span> <span class="n">link</span> <span class="n">src</span> <span class="mf">172.17.0.3</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~/getting-started/app$ ip r
default via 10.0.2.2 dev eth0
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~/getting-started/app$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
       valid_lft 82149sec preferred_lft 82149sec
    inet6 fe80::a00:27ff:fe8d:c04d/64 scope link
       valid_lft forever preferred_lft forever
3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:94:88:2c:c5 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:94ff:fe88:2cc5/64 scope link
       valid_lft forever preferred_lft forever
49: vethdb24b02@if48: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default
    link/ether 76:cd:cf:77:a1:e7 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::74cd:cfff:fe77:a1e7/64 scope link
       valid_lft forever preferred_lft forever
</pre></div>
</div>
</section>
<section id="id65">
<h4>コンテナホストのIPネットワーク設定を得る<a class="headerlink" href="#id65" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker network inspect bridge
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:/etc$ docker network inspect bridge
[
    {
        "Name": "bridge",
        "Id": "0ea33a0eab4d301b44ed5466da31833a3afe45b15fb88723a6113d5931575350",
        "Created": "2021-04-06T13:06:13.725832364Z",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16",
                    "Gateway": "172.17.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {
            "5235a0c75e3fe787f260983649daf4841b5a2f4c341b44a28bcd7cd07ce20bd2": {
                "Name": "elated_moore",
                "EndpointID": "51d715e8d002796dae5a75a3900335dc846291562142c77025bd46801d640510",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            },
            "e9efa49e7a29bb90c43a50021c437bc8f9f839c9528ec52a20ac7b13d3ea2379": {
                "Name": "modest_germain",
                "EndpointID": "57f033f87690ee2a8cf51c09d6ac5cab98e38de7a69aae037921ea3a58250ea7",
                "MacAddress": "02:42:ac:11:00:03",
                "IPv4Address": "172.17.0.3/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]
vagrant@buster:/etc$
</pre></div>
</div>
</section>
</section>
<section id="id66">
<h3>コンテナホストのディスク使用量を得る<a class="headerlink" href="#id66" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker system df

docker system df --verbose
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker system df
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          8         3         620.9MB   413.3MB (66%)
Containers      7         2         18.61kB   17.5kB (94%)
Local Volumes   1         1         8.192kB   0B (0%)
Build Cache     0         0         0B        0B
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker system df -v
Images space usage:

REPOSITORY                TAG         IMAGE ID       CREATED        SIZE      SHARED SIZE   UNIQUE SIZE   CONTAINERS
getting-started           latest      1d0cff85fe8c   25 hours ago   383.4MB   293.6MB       89.84MB       4
&lt;none&gt;                    &lt;none&gt;      996f2b1f8f65   25 hours ago   383.4MB   293.6MB       89.84MB       1
local-debian-helloworld   latest      ca921586db0e   29 hours ago   114.1MB   114.1MB       0B            0
debian                    buster      463adba1ec3f   2 days ago     114.1MB   114.1MB       0B            0
node                      12-alpine   e71ff672228f   3 days ago     88.9MB    88.9MB        0B            0
alpine                    latest      302aba9ce190   3 days ago     5.613MB   0B            5.613MB       0
docker/getting-started    latest      3ba8f2ff0727   10 days ago    27.94MB   0B            27.94MB       2
hello-world               latest      d1165f221234   3 weeks ago    13.34kB   0B            13.34kB       0

Containers space usage:

CONTAINER ID   IMAGE                    COMMAND                  LOCAL VOLUMES   SIZE      CREATED        STATUS                    NAMES
09a93ccb9c35   getting-started          "docker-entrypoint.s…"   1               0B        24 hours ago   Up 24 hours               nice_mcnulty
f66be98597da   getting-started          "docker-entrypoint.s…"   1               0B        25 hours ago   Created                   vibrant_banach
d3d9d3ade794   getting-started          "docker-entrypoint.s…"   0               8.19kB    25 hours ago   Exited (0) 24 hours ago   distracted_pike
d48f8bf34fbf   getting-started          "docker-entrypoint.s…"   0               0B        25 hours ago   Created                   hungry_engelbart
3cac8331e287   996f2b1f8f65             "docker-entrypoint.s…"   0               8.19kB    25 hours ago   Exited (0) 25 hours ago   sharp_gould
35fa1985a995   docker/getting-started   "/docker-entrypoint.…"   0               1.12kB    25 hours ago   Up 25 hours               exciting_meitner
e1a21553f8f1   docker/getting-started   "/docker-entrypoint.…"   0               1.11kB    26 hours ago   Exited (0) 25 hours ago   quizzical_moser

Local Volumes space usage:

VOLUME NAME   LINKS     SIZE
todo-db       2         8.192kB

Build cache usage: 0B

CACHE ID   CACHE TYPE   SIZE      CREATED   LAST USED   USAGE     SHARED
</pre></div>
</div>
</section>
<section id="inspect">
<h3>イメージを inspect で調べる<a class="headerlink" href="#inspect" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">repository_tag</span><span class="o">=</span><span class="s2">"alpine"</span>

docker image ls <span class="s2">"</span><span class="nv">$repository_tag</span><span class="s2">"</span>

<span class="nv">image_id</span><span class="o">=</span><span class="k">$(</span>docker image ls --format <span class="s2">"{{.ID}}"</span> <span class="s2">"</span><span class="nv">$repository_tag</span><span class="s2">"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$image_id</span><span class="s2">"</span>
docker inspect <span class="s2">"</span><span class="nv">$image_id</span><span class="s2">"</span> <span class="p">|</span> jq .
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">"Id"</span><span class="p">:</span> <span class="s2">"sha256:302aba9ce190db9e247d710f4794cc303b169035de2048e76b82c9edbddbef4e"</span><span class="p">,</span>
    <span class="nt">"RepoTags"</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">"alpine:latest"</span>
    <span class="p">],</span>
    <span class="nt">"RepoDigests"</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">"alpine@sha256:826f70e0ac33e99a72cf20fb0571245a8fee52d68cb26d8bc58e53bfa65dcdfa"</span>
    <span class="p">],</span>
    <span class="nt">"Parent"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="nt">"Comment"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="nt">"Created"</span><span class="p">:</span> <span class="s2">"2021-03-25T22:19:32.885247238Z"</span><span class="p">,</span>
    <span class="nt">"Container"</span><span class="p">:</span> <span class="s2">"a7362c98f21a3d7476e321beed354c955da6a806d32b710391fce21479bdeab8"</span><span class="p">,</span>
    <span class="nt">"ContainerConfig"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Hostname"</span><span class="p">:</span> <span class="s2">"a7362c98f21a"</span><span class="p">,</span>
      <span class="nt">"Domainname"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"User"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"AttachStdin"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"AttachStdout"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"AttachStderr"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Tty"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"OpenStdin"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"StdinOnce"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Env"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
      <span class="p">],</span>
      <span class="nt">"Cmd"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"/bin/sh"</span><span class="p">,</span>
        <span class="s2">"-c"</span><span class="p">,</span>
        <span class="s2">"#(nop) "</span><span class="p">,</span>
        <span class="s2">"CMD [\"/bin/sh\"]"</span>
      <span class="p">],</span>
      <span class="nt">"Image"</span><span class="p">:</span> <span class="s2">"sha256:a57a6c03a1358575578a48f9c200232d07a5e8b66dd7b1dfaac59b78627ea22c"</span><span class="p">,</span>
      <span class="nt">"Volumes"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"WorkingDir"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Entrypoint"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"OnBuild"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"Labels"</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nt">"DockerVersion"</span><span class="p">:</span> <span class="s2">"19.03.12"</span><span class="p">,</span>
    <span class="nt">"Author"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="nt">"Config"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Hostname"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Domainname"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"User"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"AttachStdin"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"AttachStdout"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"AttachStderr"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Tty"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"OpenStdin"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"StdinOnce"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Env"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
      <span class="p">],</span>
      <span class="nt">"Cmd"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"/bin/sh"</span>
      <span class="p">],</span>
      <span class="nt">"Image"</span><span class="p">:</span> <span class="s2">"sha256:a57a6c03a1358575578a48f9c200232d07a5e8b66dd7b1dfaac59b78627ea22c"</span><span class="p">,</span>
      <span class="nt">"Volumes"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"WorkingDir"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Entrypoint"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"OnBuild"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"Labels"</span><span class="p">:</span> <span class="kc">null</span>
    <span class="p">},</span>
    <span class="nt">"Architecture"</span><span class="p">:</span> <span class="s2">"amd64"</span><span class="p">,</span>
    <span class="nt">"Os"</span><span class="p">:</span> <span class="s2">"linux"</span><span class="p">,</span>
    <span class="nt">"Size"</span><span class="p">:</span> <span class="mi">5613158</span><span class="p">,</span>
    <span class="nt">"VirtualSize"</span><span class="p">:</span> <span class="mi">5613158</span><span class="p">,</span>
    <span class="nt">"GraphDriver"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Data"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"MergedDir"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/overlay2/f8c1b05348eece1c78b259bffed2f89fa4cb254c02b03fc89924b5d94a00b87c/merged"</span><span class="p">,</span>
        <span class="nt">"UpperDir"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/overlay2/f8c1b05348eece1c78b259bffed2f89fa4cb254c02b03fc89924b5d94a00b87c/diff"</span><span class="p">,</span>
        <span class="nt">"WorkDir"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/overlay2/f8c1b05348eece1c78b259bffed2f89fa4cb254c02b03fc89924b5d94a00b87c/work"</span>
      <span class="p">},</span>
      <span class="nt">"Name"</span><span class="p">:</span> <span class="s2">"overlay2"</span>
    <span class="p">},</span>
    <span class="nt">"RootFS"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Type"</span><span class="p">:</span> <span class="s2">"layers"</span><span class="p">,</span>
      <span class="nt">"Layers"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"sha256:0f7b3ff8b310adb0c38fa8108967e51e3431bc4b7ce350de93839eeffcefd34c"</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">"Metadata"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"LastTagTime"</span><span class="p">:</span> <span class="s2">"0001-01-01T00:00:00Z"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="id67">
<h3>コンテナを inspect で調べる<a class="headerlink" href="#id67" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ポートや、ボリュームのマウントなどもわかる。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ancestor</span><span class="o">=</span><span class="s2">"hello-world"</span>
<span class="nv">container_id</span><span class="o">=</span><span class="k">$(</span>
  docker container ls --all <span class="se">\</span>
    --filter <span class="s2">"ancestor=</span><span class="nv">$ancestor</span><span class="s2">"</span> --format <span class="s2">"{{.ID}}"</span>
<span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$container_id</span><span class="s2">"</span>
docker inspect <span class="s2">"</span><span class="nv">$container_id</span><span class="s2">"</span> <span class="p">|</span> jq .
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">"Id"</span><span class="p">:</span> <span class="s2">"d2374d60ec7798dc5424c58f0497010038e3deca73eb3f150e3974c722a40f2e"</span><span class="p">,</span>
    <span class="nt">"Created"</span><span class="p">:</span> <span class="s2">"2021-03-28T08:13:22.385973565Z"</span><span class="p">,</span>
    <span class="nt">"Path"</span><span class="p">:</span> <span class="s2">"/hello"</span><span class="p">,</span>
    <span class="nt">"Args"</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">"State"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Status"</span><span class="p">:</span> <span class="s2">"exited"</span><span class="p">,</span>
      <span class="nt">"Running"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Paused"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Restarting"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"OOMKilled"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Dead"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Pid"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"ExitCode"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"Error"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"StartedAt"</span><span class="p">:</span> <span class="s2">"2021-03-28T08:13:24.81669409Z"</span><span class="p">,</span>
      <span class="nt">"FinishedAt"</span><span class="p">:</span> <span class="s2">"2021-03-28T08:13:24.831931088Z"</span>
    <span class="p">},</span>
    <span class="nt">"Image"</span><span class="p">:</span> <span class="s2">"sha256:d1165f2212346b2bab48cb01c1e39ee8ad1be46b87873d9ca7a4e434980a7726"</span><span class="p">,</span>
    <span class="nt">"ResolvConfPath"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/containers/d2374d60ec7798dc5424c58f0497010038e3deca73eb3f150e3974c722a40f2e/resolv.conf"</span><span class="p">,</span>
    <span class="nt">"HostnamePath"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/containers/d2374d60ec7798dc5424c58f0497010038e3deca73eb3f150e3974c722a40f2e/hostname"</span><span class="p">,</span>
    <span class="nt">"HostsPath"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/containers/d2374d60ec7798dc5424c58f0497010038e3deca73eb3f150e3974c722a40f2e/hosts"</span><span class="p">,</span>
    <span class="nt">"LogPath"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/containers/d2374d60ec7798dc5424c58f0497010038e3deca73eb3f150e3974c722a40f2e/d2374d60ec7798dc5424c58f0497010038e3deca73eb3f150e3974c722a40f2e-json.log"</span><span class="p">,</span>
    <span class="nt">"Name"</span><span class="p">:</span> <span class="s2">"/laughing_einstein"</span><span class="p">,</span>
    <span class="nt">"RestartCount"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">"Driver"</span><span class="p">:</span> <span class="s2">"overlay2"</span><span class="p">,</span>
    <span class="nt">"Platform"</span><span class="p">:</span> <span class="s2">"linux"</span><span class="p">,</span>
    <span class="nt">"MountLabel"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="nt">"ProcessLabel"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="nt">"AppArmorProfile"</span><span class="p">:</span> <span class="s2">"docker-default"</span><span class="p">,</span>
    <span class="nt">"ExecIDs"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nt">"HostConfig"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Binds"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"ContainerIDFile"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"LogConfig"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"Type"</span><span class="p">:</span> <span class="s2">"json-file"</span><span class="p">,</span>
        <span class="nt">"Config"</span><span class="p">:</span> <span class="p">{}</span>
      <span class="p">},</span>
      <span class="nt">"NetworkMode"</span><span class="p">:</span> <span class="s2">"default"</span><span class="p">,</span>
      <span class="nt">"PortBindings"</span><span class="p">:</span> <span class="p">{},</span>
      <span class="nt">"RestartPolicy"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"Name"</span><span class="p">:</span> <span class="s2">"no"</span><span class="p">,</span>
        <span class="nt">"MaximumRetryCount"</span><span class="p">:</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="nt">"AutoRemove"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"VolumeDriver"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"VolumesFrom"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"CapAdd"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"CapDrop"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"CgroupnsMode"</span><span class="p">:</span> <span class="s2">"host"</span><span class="p">,</span>
      <span class="nt">"Dns"</span><span class="p">:</span> <span class="p">[],</span>
      <span class="nt">"DnsOptions"</span><span class="p">:</span> <span class="p">[],</span>
      <span class="nt">"DnsSearch"</span><span class="p">:</span> <span class="p">[],</span>
      <span class="nt">"ExtraHosts"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"GroupAdd"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"IpcMode"</span><span class="p">:</span> <span class="s2">"private"</span><span class="p">,</span>
      <span class="nt">"Cgroup"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Links"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"OomScoreAdj"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"PidMode"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Privileged"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"PublishAllPorts"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"ReadonlyRootfs"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"SecurityOpt"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"UTSMode"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"UsernsMode"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"ShmSize"</span><span class="p">:</span> <span class="mi">67108864</span><span class="p">,</span>
      <span class="nt">"Runtime"</span><span class="p">:</span> <span class="s2">"runc"</span><span class="p">,</span>
      <span class="nt">"ConsoleSize"</span><span class="p">:</span> <span class="p">[</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="mi">0</span>
      <span class="p">],</span>
      <span class="nt">"Isolation"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"CpuShares"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"Memory"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"NanoCpus"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"CgroupParent"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"BlkioWeight"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"BlkioWeightDevice"</span><span class="p">:</span> <span class="p">[],</span>
      <span class="nt">"BlkioDeviceReadBps"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"BlkioDeviceWriteBps"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"BlkioDeviceReadIOps"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"BlkioDeviceWriteIOps"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"CpuPeriod"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"CpuQuota"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"CpuRealtimePeriod"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"CpuRealtimeRuntime"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"CpusetCpus"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"CpusetMems"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Devices"</span><span class="p">:</span> <span class="p">[],</span>
      <span class="nt">"DeviceCgroupRules"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"DeviceRequests"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"KernelMemory"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"KernelMemoryTCP"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"MemoryReservation"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"MemorySwap"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"MemorySwappiness"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"OomKillDisable"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"PidsLimit"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"Ulimits"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"CpuCount"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"CpuPercent"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"IOMaximumIOps"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"IOMaximumBandwidth"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"MaskedPaths"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"/proc/asound"</span><span class="p">,</span>
        <span class="s2">"/proc/acpi"</span><span class="p">,</span>
        <span class="s2">"/proc/kcore"</span><span class="p">,</span>
        <span class="s2">"/proc/keys"</span><span class="p">,</span>
        <span class="s2">"/proc/latency_stats"</span><span class="p">,</span>
        <span class="s2">"/proc/timer_list"</span><span class="p">,</span>
        <span class="s2">"/proc/timer_stats"</span><span class="p">,</span>
        <span class="s2">"/proc/sched_debug"</span><span class="p">,</span>
        <span class="s2">"/proc/scsi"</span><span class="p">,</span>
        <span class="s2">"/sys/firmware"</span>
      <span class="p">],</span>
      <span class="nt">"ReadonlyPaths"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"/proc/bus"</span><span class="p">,</span>
        <span class="s2">"/proc/fs"</span><span class="p">,</span>
        <span class="s2">"/proc/irq"</span><span class="p">,</span>
        <span class="s2">"/proc/sys"</span><span class="p">,</span>
        <span class="s2">"/proc/sysrq-trigger"</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">"GraphDriver"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Data"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"LowerDir"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/overlay2/75f7d8d93f73e6563b24ee041571402869505c623ba5768e99274761962ea7ee-init/diff:/var/lib/docker/overlay2/f1cf15ddee3393f5586aa0e8b615c7bb9676012fb5fe5f36cd20156b8e562578/diff"</span><span class="p">,</span>
        <span class="nt">"MergedDir"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/overlay2/75f7d8d93f73e6563b24ee041571402869505c623ba5768e99274761962ea7ee/merged"</span><span class="p">,</span>
        <span class="nt">"UpperDir"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/overlay2/75f7d8d93f73e6563b24ee041571402869505c623ba5768e99274761962ea7ee/diff"</span><span class="p">,</span>
        <span class="nt">"WorkDir"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/overlay2/75f7d8d93f73e6563b24ee041571402869505c623ba5768e99274761962ea7ee/work"</span>
      <span class="p">},</span>
      <span class="nt">"Name"</span><span class="p">:</span> <span class="s2">"overlay2"</span>
    <span class="p">},</span>
    <span class="nt">"Mounts"</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">"Config"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Hostname"</span><span class="p">:</span> <span class="s2">"d2374d60ec77"</span><span class="p">,</span>
      <span class="nt">"Domainname"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"User"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"AttachStdin"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"AttachStdout"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">"AttachStderr"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">"Tty"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"OpenStdin"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"StdinOnce"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"Env"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
      <span class="p">],</span>
      <span class="nt">"Cmd"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"/hello"</span>
      <span class="p">],</span>
      <span class="nt">"Image"</span><span class="p">:</span> <span class="s2">"hello-world"</span><span class="p">,</span>
      <span class="nt">"Volumes"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"WorkingDir"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Entrypoint"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"OnBuild"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"Labels"</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nt">"NetworkSettings"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"Bridge"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"SandboxID"</span><span class="p">:</span> <span class="s2">"a608f23d9bae7ed45b16128d51e73001ddd1f27a996bd7cff4dac55140b21eeb"</span><span class="p">,</span>
      <span class="nt">"HairpinMode"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">"LinkLocalIPv6Address"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"LinkLocalIPv6PrefixLen"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"Ports"</span><span class="p">:</span> <span class="p">{},</span>
      <span class="nt">"SandboxKey"</span><span class="p">:</span> <span class="s2">"/var/run/docker/netns/a608f23d9bae"</span><span class="p">,</span>
      <span class="nt">"SecondaryIPAddresses"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"SecondaryIPv6Addresses"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nt">"EndpointID"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Gateway"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"GlobalIPv6Address"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"GlobalIPv6PrefixLen"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"IPAddress"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"IPPrefixLen"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">"IPv6Gateway"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"MacAddress"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
      <span class="nt">"Networks"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"bridge"</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">"IPAMConfig"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
          <span class="nt">"Links"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
          <span class="nt">"Aliases"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
          <span class="nt">"NetworkID"</span><span class="p">:</span> <span class="s2">"4ef897a0a3f4dfee7a44511be818e1730c1f2d395934d454d64144d4a56b596b"</span><span class="p">,</span>
          <span class="nt">"EndpointID"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
          <span class="nt">"Gateway"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
          <span class="nt">"IPAddress"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
          <span class="nt">"IPPrefixLen"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nt">"IPv6Gateway"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
          <span class="nt">"GlobalIPv6Address"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
          <span class="nt">"GlobalIPv6PrefixLen"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nt">"MacAddress"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
          <span class="nt">"DriverOpts"</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="id68">
<h3>ボリュームを inspect で調べる<a class="headerlink" href="#id68" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">volume_name</span><span class="o">=</span><span class="s2">"todo-db"</span>
docker volume inspect <span class="s2">"</span><span class="nv">$volume_name</span><span class="s2">"</span>
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">"CreatedAt"</span><span class="p">:</span> <span class="s2">"2021-03-28T13:04:37Z"</span><span class="p">,</span>
        <span class="nt">"Driver"</span><span class="p">:</span> <span class="s2">"local"</span><span class="p">,</span>
        <span class="nt">"Labels"</span><span class="p">:</span> <span class="p">{},</span>
        <span class="nt">"Mountpoint"</span><span class="p">:</span> <span class="s2">"/var/lib/docker/volumes/todo-db/_data"</span><span class="p">,</span>
        <span class="nt">"Name"</span><span class="p">:</span> <span class="s2">"todo-db"</span><span class="p">,</span>
        <span class="nt">"Options"</span><span class="p">:</span> <span class="p">{},</span>
        <span class="nt">"Scope"</span><span class="p">:</span> <span class="s2">"local"</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="tips">
<h2>Tips<a class="headerlink" href="#tips" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="id69">
<h3>すべてのオブジェクトを消す<a class="headerlink" href="#id69" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># すべてのコンテナを止める</span>
<span class="nv">container_id_list</span><span class="o">=</span><span class="k">$(</span>docker container ls --all --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$container_id_list</span><span class="s2">"</span>
docker container stop <span class="k">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$container_id_list</span><span class="s2">"</span><span class="k">)</span>

<span class="c1"># すべてのコンテナを消す</span>
<span class="nv">container_id_list</span><span class="o">=</span><span class="k">$(</span>docker container ls --all --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$container_id_list</span><span class="s2">"</span>
docker container rm <span class="k">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$container_id_list</span><span class="s2">"</span><span class="k">)</span>

<span class="c1"># すべてのイメージを消す</span>
<span class="nv">image_id_list</span><span class="o">=</span><span class="k">$(</span>docker image ls --all --format <span class="s2">"{{.ID}}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$image_id_list</span><span class="s2">"</span>
docker image rm <span class="k">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$image_id_list</span><span class="s2">"</span><span class="k">)</span>

<span class="c1"># すべてのボリュームを消す</span>
<span class="nv">volume_name_list</span><span class="o">=</span><span class="k">$(</span>docker volume ls --format <span class="s2">"{{ .Name }}"</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$volume_name_list</span><span class="s2">"</span>
docker volume rm <span class="k">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$volume_name_list</span><span class="s2">"</span><span class="k">)</span>

<span class="c1"># ドライバが bridge であるネットワークのうち、</span>
<span class="c1"># インストール直後に存在する名前が bridge 以外のネットワークを消すための</span>
<span class="c1"># コマンドを出力する</span>
docker network ls --filter <span class="s2">"driver=bridge"</span> --format <span class="s2">"{{.ID}} {{.Name}}"</span> <span class="se">\</span>
<span class="p">|</span> grep -P -v <span class="s1">'\sbridge$'</span> <span class="se">\</span>
<span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> -r net_id name<span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">"# name: </span><span class="nv">$name</span><span class="s2">"</span>
    <span class="nb">echo</span> <span class="s2">"docker network rm </span><span class="nv">$net_id</span><span class="s2">"</span>
  <span class="k">done</span>

<span class="c1"># 削除後の各種オブジェクトを確認する</span>
docker container ls --all
docker image ls
docker volume ls
docker network ls
</pre></div>
</div>
</section>
<section id="os">
<h3>OSとコンテナの組み合わせでどのような動きになるか確認してみる<a class="headerlink" href="#os" title="このヘッドラインへのパーマリンク">¶</a></h3>
<section id="centos7-docker-engine-centos8">
<h4>CentOS7 仮想マシンの Docker Engine で CentOS8 コンテナを起動する<a class="headerlink" href="#centos7-docker-engine-centos8" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># コンテナホストは CentOS7</span>
cat /etc/redhat-release
uname -a

<span class="c1"># コンテナ内は CentOS8</span>
docker run centos:centos8 cat /etc/redhat-release
docker run centos:centos8 uname -a
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[vagrant@localhost ~]$ cat /etc/redhat-release
CentOS Linux release 7.9.2009 (Core)
[vagrant@localhost ~]$ uname -a
Linux localhost.localdomain 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux

[vagrant@localhost ~]$ docker run centos:centos8 cat /etc/redhat-release
CentOS Linux release 8.3.2011
[vagrant@localhost ~]$ docker run centos:centos8 uname -a
Linux 8fcdae39d04c 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
</pre></div>
</div>
<p>https://stackoverflow.com/a/48094310</p>
<blockquote>
<div><p>Now since the kernel is not part of the image, it is possible to create a Docker image that would work on one kernel version and fail on another. For instance, you can request a system call that might not exist in an older kernel version.</p>
</div></blockquote>
</section>
<section id="debian-docker-engine-centos8">
<h4>Debian 仮想マシンの Docker Engine で CentOS8 コンテナを起動する<a class="headerlink" href="#debian-docker-engine-centos8" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># コンテナホストは debian(buster)</span>
<span class="n">uname</span> <span class="o">-</span><span class="n">a</span>

<span class="c1"># コンテナ内は CentOS8</span>
<span class="n">docker</span> <span class="n">run</span> <span class="n">centos</span><span class="p">:</span><span class="n">centos8</span> <span class="n">uname</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ uname -a
Linux buster 4.19.0-14-amd64 #1 SMP Debian 4.19.171-2 (2021-01-30) x86_64 GNU/Linux
vagrant@buster:~$ docker run centos:centos8 uname -a
Linux 55f1ac06128d 4.19.0-14-amd64 #1 SMP Debian 4.19.171-2 (2021-01-30) x86_64 x86_64 x86_64 GNU/Linux
</pre></div>
</div>
</section>
</section>
</section>
<section id="id70">
<h2>付録: docker コマンド出力<a class="headerlink" href="#id70" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="docker-version">
<h3>docker version<a class="headerlink" href="#docker-version" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker version
Client: Docker Engine - Community
 Version:           20.10.5
 API version:       1.41
 Go version:        go1.13.15
 Git commit:        55c4c88
 Built:             Tue Mar  2 20:17:50 2021
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      true

Server: Docker Engine - Community
 Engine:
  Version:          20.10.5
  API version:      1.41 (minimum version 1.12)
  Go version:       go1.13.15
  Git commit:       363e9a8
  Built:            Tue Mar  2 20:15:47 2021
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.4.4
  GitCommit:        05f951a3781f4f2c1911b05e61c160e9c30eaa8e
 runc:
  Version:          1.0.0-rc93
  GitCommit:        12644e614e25b05da6fd08a38ffa0cfe1903fdec
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0
</pre></div>
</div>
</section>
<section id="id71">
<h3>docker<a class="headerlink" href="#id71" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker

Usage:  docker [OPTIONS] COMMAND

A self-sufficient runtime for containers

Options:
      --config string      Location of client config files (default "/root/.docker")
  -c, --context string     Name of the context to use to connect to the daemon (overrides DOCKER_HOST env var and default context set with "docker context use")
  -D, --debug              Enable debug mode
  -H, --host list          Daemon socket(s) to connect to
  -l, --log-level string   Set the logging level ("debug"|"info"|"warn"|"error"|"fatal") (default "info")
      --tls                Use TLS; implied by --tlsverify
      --tlscacert string   Trust certs signed only by this CA (default "/root/.docker/ca.pem")
      --tlscert string     Path to TLS certificate file (default "/root/.docker/cert.pem")
      --tlskey string      Path to TLS key file (default "/root/.docker/key.pem")
      --tlsverify          Use TLS and verify the remote
  -v, --version            Print version information and quit

Management Commands:
  app*        Docker App (Docker Inc., v0.9.1-beta3)
  builder     Manage builds
  buildx*     Build with BuildKit (Docker Inc., v0.5.1-docker)
  config      Manage Docker configs
  container   Manage containers
  context     Manage contexts
  image       Manage images
  manifest    Manage Docker image manifests and manifest lists
  network     Manage networks
  node        Manage Swarm nodes
  plugin      Manage plugins
  secret      Manage Docker secrets
  service     Manage services
  stack       Manage Docker stacks
  swarm       Manage Swarm
  system      Manage Docker
  trust       Manage trust on Docker images
  volume      Manage volumes

Commands:
  attach      Attach local standard input, output, and error streams to a running container
  build       Build an image from a Dockerfile
  commit      Create a new image from a container's changes
  cp          Copy files/folders between a container and the local filesystem
  create      Create a new container
  diff        Inspect changes to files or directories on a container's filesystem
  events      Get real time events from the server
  exec        Run a command in a running container
  export      Export a container's filesystem as a tar archive
  history     Show the history of an image
  images      List images
  import      Import the contents from a tarball to create a filesystem image
  info        Display system-wide information
  inspect     Return low-level information on Docker objects
  kill        Kill one or more running containers
  load        Load an image from a tar archive or STDIN
  login       Log in to a Docker registry
  logout      Log out from a Docker registry
  logs        Fetch the logs of a container
  pause       Pause all processes within one or more containers
  port        List port mappings or a specific mapping for the container
  ps          List containers
  pull        Pull an image or a repository from a registry
  push        Push an image or a repository to a registry
  rename      Rename a container
  restart     Restart one or more containers
  rm          Remove one or more containers
  rmi         Remove one or more images
  run         Run a command in a new container
  save        Save one or more images to a tar archive (streamed to STDOUT by default)
  search      Search the Docker Hub for images
  start       Start one or more stopped containers
  stats       Display a live stream of container(s) resource usage statistics
  stop        Stop one or more running containers
  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE
  top         Display the running processes of a container
  unpause     Unpause all processes within one or more containers
  update      Update configuration of one or more containers
  version     Show the Docker version information
  wait        Block until one or more containers stop, then print their exit codes

Run 'docker COMMAND --help' for more information on a command.

To get more help with docker, check out our guides at https://docs.docker.com/go/guides/
</pre></div>
</div>
</section>
<section id="docker-container">
<h3>docker container<a class="headerlink" href="#docker-container" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker container

Usage:  docker container COMMAND

Manage containers

Commands:
  attach      Attach local standard input, output, and error streams to a running container
  commit      Create a new image from a container's changes
  cp          Copy files/folders between a container and the local filesystem
  create      Create a new container
  diff        Inspect changes to files or directories on a container's filesystem
  exec        Run a command in a running container
  export      Export a container's filesystem as a tar archive
  inspect     Display detailed information on one or more containers
  kill        Kill one or more running containers
  logs        Fetch the logs of a container
  ls          List containers
  pause       Pause all processes within one or more containers
  port        List port mappings or a specific mapping for the container
  prune       Remove all stopped containers
  rename      Rename a container
  restart     Restart one or more containers
  rm          Remove one or more containers
  run         Run a command in a new container
  start       Start one or more stopped containers
  stats       Display a live stream of container(s) resource usage statistics
  stop        Stop one or more running containers
  top         Display the running processes of a container
  unpause     Unpause all processes within one or more containers
  update      Update configuration of one or more containers
  wait        Block until one or more containers stop, then print their exit codes

Run 'docker container COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-config">
<h3>docker config<a class="headerlink" href="#docker-config" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker config

Usage:  docker config COMMAND

Manage Docker configs

Commands:
  create      Create a config from a file or STDIN
  inspect     Display detailed information on one or more configs
  ls          List configs
  rm          Remove one or more configs

Run 'docker config COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-context">
<h3>docker context<a class="headerlink" href="#docker-context" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ vagrant@buster:~$ docker context

Usage:  docker context COMMAND

Manage contexts

Commands:
  create      Create a context
  export      Export a context to a tar or kubeconfig file
  import      Import a context from a tar or zip file
  inspect     Display detailed information on one or more contexts
  ls          List contexts
  rm          Remove one or more contexts
  update      Update a context
  use         Set the current docker context

Run 'docker context COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-image">
<h3>docker image<a class="headerlink" href="#docker-image" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker image

Usage:  docker image COMMAND

Manage images

Commands:
  build       Build an image from a Dockerfile
  history     Show the history of an image
  import      Import the contents from a tarball to create a filesystem image
  inspect     Display detailed information on one or more images
  load        Load an image from a tar archive or STDIN
  ls          List images
  prune       Remove unused images
  pull        Pull an image or a repository from a registry
  push        Push an image or a repository to a registry
  rm          Remove one or more images
  save        Save one or more images to a tar archive (streamed to STDOUT by default)
  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE

Run 'docker image COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-manifest">
<h3>docker manifest<a class="headerlink" href="#docker-manifest" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker manifest

Usage:  docker manifest COMMAND

The **docker manifest** command has subcommands for managing image manifests and
manifest lists. A manifest list allows you to use one name to refer to the same image
built for multiple architectures.

To see help for a subcommand, use:

    docker manifest CMD --help

For full details on using docker manifest lists, see the registry v2 specification.

EXPERIMENTAL:
  docker manifest is an experimental feature.
  Experimental features provide early access to product functionality. These
  features may change between releases without warning, or can be removed from a
  future release. Learn more about experimental features in our documentation:
  https://docs.docker.com/go/experimental/

Commands:
  annotate    Add additional information to a local image manifest
  create      Create a local manifest list for annotating and pushing to a registry
  inspect     Display an image manifest, or manifest list
  push        Push a manifest list to a repository
  rm          Delete one or more manifest lists from local storage

Run 'docker manifest COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-network">
<h3>docker network<a class="headerlink" href="#docker-network" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker network

Usage:  docker network COMMAND

Manage networks

Commands:
  connect     Connect a container to a network
  create      Create a network
  disconnect  Disconnect a container from a network
  inspect     Display detailed information on one or more networks
  ls          List networks
  prune       Remove all unused networks
  rm          Remove one or more networks

Run 'docker network COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-node">
<h3>docker node<a class="headerlink" href="#docker-node" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker node

Usage:  docker node COMMAND

Manage Swarm nodes

Commands:
  demote      Demote one or more nodes from manager in the swarm
  inspect     Display detailed information on one or more nodes
  ls          List nodes in the swarm
  promote     Promote one or more nodes to manager in the swarm
  ps          List tasks running on one or more nodes, defaults to current node
  rm          Remove one or more nodes from the swarm
  update      Update a node

Run 'docker node COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-service">
<h3>docker service<a class="headerlink" href="#docker-service" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker service

Usage:  docker service COMMAND

Manage services

Commands:
  create      Create a new service
  inspect     Display detailed information on one or more services
  logs        Fetch the logs of a service or task
  ls          List services
  ps          List the tasks of one or more services
  rm          Remove one or more services
  rollback    Revert changes to a service's configuration
  scale       Scale one or multiple replicated services
  update      Update a service

Run 'docker service COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-stack">
<h3>docker stack<a class="headerlink" href="#docker-stack" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker stack

Usage:  docker stack [OPTIONS] COMMAND

Manage Docker stacks

Options:
      --orchestrator string   Orchestrator to use (swarm|kubernetes|all)

Commands:
  deploy      Deploy a new stack or update an existing stack
  ls          List stacks
  ps          List the tasks in the stack
  rm          Remove one or more stacks
  services    List the services in the stack

Run 'docker stack COMMAND --help' for more information on a command
</pre></div>
</div>
</section>
<section id="docker-swarm">
<h3>docker swarm<a class="headerlink" href="#docker-swarm" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker swarm

Usage:  docker swarm COMMAND

Manage Swarm

Commands:
  ca          Display and rotate the root CA
  init        Initialize a swarm
  join        Join a swarm as a node and/or manager
  join-token  Manage join tokens
  leave       Leave the swarm
  unlock      Unlock swarm
  unlock-key  Manage the unlock key
  update      Update the swarm

Run 'docker swarm COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-system">
<h3>docker system<a class="headerlink" href="#docker-system" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker system

Usage:  docker system COMMAND

Manage Docker

Commands:
  df          Show docker disk usage
  events      Get real time events from the server
  info        Display system-wide information
  prune       Remove unused data

Run 'docker system COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-secret">
<h3>docker secret<a class="headerlink" href="#docker-secret" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker secret

Usage:  docker secret COMMAND

Manage Docker secrets

Commands:
  create      Create a secret from a file or STDIN as content
  inspect     Display detailed information on one or more secrets
  ls          List secrets
  rm          Remove one or more secrets

Run 'docker secret COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-trust">
<h3>docker trust<a class="headerlink" href="#docker-trust" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker trust

Usage:  docker trust COMMAND

Manage trust on Docker images

Management Commands:
  key         Manage keys for signing Docker images
  signer      Manage entities who can sign Docker images

Commands:
  inspect     Return low-level information about keys and signatures
  revoke      Remove trust for an image
  sign        Sign an image

Run 'docker trust COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
<section id="docker-volume">
<h3>docker volume<a class="headerlink" href="#docker-volume" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker volume

Usage:  docker volume COMMAND

Manage volumes

Commands:
  create      Create a volume
  inspect     Display detailed information on one or more volumes
  ls          List volumes
  prune       Remove all unused local volumes
  rm          Remove one or more volumes

Run 'docker volume COMMAND --help' for more information on a command.
</pre></div>
</div>
</section>
</section>
<section id="id72">
<h2>付録: docker-compose コマンド出力<a class="headerlink" href="#id72" title="このヘッドラインへのパーマリンク">¶</a></h2>
<section id="docker-compose-version">
<h3>docker-compose version<a class="headerlink" href="#docker-compose-version" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker-compose --version
docker-compose version 1.29.0, build 07737305
</pre></div>
</div>
</section>
<section id="id73">
<h3>docker-compose<a class="headerlink" href="#id73" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vagrant@buster:~$ docker-compose --help
Define and run multi-container applications with Docker.

Usage:
  docker-compose [-f &lt;arg&gt;...] [--profile &lt;name&gt;...] [options] [--] [COMMAND] [ARGS...]
  docker-compose -h|--help

Options:
  -f, --file FILE             Specify an alternate compose file
                              (default: docker-compose.yml)
  -p, --project-name NAME     Specify an alternate project name
                              (default: directory name)
  --profile NAME              Specify a profile to enable
  -c, --context NAME          Specify a context name
  --verbose                   Show more output
  --log-level LEVEL           Set log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
  --ansi (never|always|auto)  Control when to print ANSI control characters
  --no-ansi                   Do not print ANSI control characters (DEPRECATED)
  -v, --version               Print version and exit
  -H, --host HOST             Daemon socket to connect to

  --tls                       Use TLS; implied by --tlsverify
  --tlscacert CA_PATH         Trust certs signed only by this CA
  --tlscert CLIENT_CERT_PATH  Path to TLS certificate file
  --tlskey TLS_KEY_PATH       Path to TLS key file
  --tlsverify                 Use TLS and verify the remote
  --skip-hostname-check       Don't check the daemon's hostname against the
                              name specified in the client certificate
  --project-directory PATH    Specify an alternate working directory
                              (default: the path of the Compose file)
  --compatibility             If set, Compose will attempt to convert keys
                              in v3 files to their non-Swarm equivalent (DEPRECATED)
  --env-file PATH             Specify an alternate environment file

Commands:
  build              Build or rebuild services
  config             Validate and view the Compose file
  create             Create services
  down               Stop and remove resources
  events             Receive real time events from containers
  exec               Execute a command in a running container
  help               Get help on a command
  images             List images
  kill               Kill containers
  logs               View output from containers
  pause              Pause services
  port               Print the public port for a port binding
  ps                 List containers
  pull               Pull service images
  push               Push service images
  restart            Restart services
  rm                 Remove stopped containers
  run                Run a one-off command
  scale              Set number of containers for a service
  start              Start services
  stop               Stop services
  top                Display the running processes
  unpause            Unpause services
  up                 Create and start containers
  version            Show version information and quit
</pre></div>
</div>
</section>
<section id="sphinx">
<h3>Sphinx のコードをビルドする<a class="headerlink" href="#sphinx" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>次のコマンドで生成される Sphinx ドキュメントのソースを用意し、
docker build すると、
nginx でコンテンツを提供できます。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>poetry install
poetry run sphinx-build -M html <span class="nb">source</span> build
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">name_tag</span><span class="o">=</span><span class="s2">"local-sphinx"</span>

<span class="nv">tmpdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d /tmp/tmp.XXXXXXXXXX<span class="k">)</span>
<span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$tmpdir</span><span class="s2">/tmp-</span><span class="si">${</span><span class="nv">name_tag</span><span class="si">}</span><span class="s2">"</span>
mkdir -pv <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>

<span class="c1"># poetry をインストールする。</span>
curl -L -o get-poetry.py <span class="se">\</span>
  https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py
python3 get-poetry.py -y

poetry init
poetry add Sphinx
poetry shell

cat <span class="s">&lt;&lt;'__DOCKERFILE__' | tee ./Dockerfile</span>
<span class="s">FROM debian:buster AS build-env</span>
<span class="s">RUN apt-get update</span>
<span class="s">ENV DEBCONF_NOWARNINGS=yes</span>
<span class="s">ADD . /app</span>
<span class="s">WORKDIR /app</span>
<span class="s">RUN apt-get install -y ca-certificates python3 python3-distutils \</span>
<span class="s">  &amp;&amp; python3 get-poetry.py -y \</span>
<span class="s">  &amp;&amp; /root/.poetry/bin/poetry install \</span>
<span class="s">  &amp;&amp; /root/.poetry/bin/poetry run sphinx-build -M html source build</span>

<span class="s">FROM debian:buster</span>
<span class="s">RUN apt-get update</span>
<span class="s">ENV DEBCONF_NOWARNINGS=yes</span>
<span class="s">RUN apt-get install -y nginx \</span>
<span class="s">  &amp;&amp; apt-get -y clean \</span>
<span class="s">  &amp;&amp; rm -rf /var/lib/apt/lists/* \</span>
<span class="s">  &amp;&amp; rm -f /var/www/html/index.nginx-debian.html</span>
<span class="s">COPY --from=build-env /app/build/html /var/www/html</span>

<span class="s"># 本番用には不要なバイナリ ps, curl, vim を導入する。</span>
<span class="s">RUN apt-get update \</span>
<span class="s">  &amp;&amp; apt-get install procps curl vim-tiny -y \</span>
<span class="s">  &amp;&amp; rm -rf /var/lib/apt/lists/*</span>

<span class="s">ENTRYPOINT ["/usr/sbin/nginx", "-g", "daemon off;"]</span>
<span class="s">EXPOSE 80</span>
<span class="s">__DOCKERFILE__</span>

docker build -t <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span> .

docker image ls <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
    <span class="c1"># REPOSITORY            TAG       IMAGE ID       CREATED         SIZE</span>
    <span class="c1"># local-debian-port80   latest    d9337ef0dddc   5 seconds ago   114MB</span>

<span class="c1"># もし加えたイメージを実行するなら次の行を実行する</span>
docker run -dp <span class="m">18000</span>:8000 <span class="s2">"</span><span class="nv">$name_tag</span><span class="s2">"</span>
    <span class="c1"># CONTAINER ID   IMAGE                   COMMAND                  CREATED              STATUS              PORTS                                         NAMES</span>
    <span class="c1"># 7723abae0c9a   local-debian-port8000   "/usr/bin/python3 -m…"   About a minute ago   Up About a minute   0.0.0.0:18000-&gt;8000/tcp, :::18000-&gt;8000/tcp   keen_knuth</span>

curl -s http://localhost:10080/
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="kubernetes.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Kubernetes</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="container.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">コンテナ</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, kumarstack55 |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>. |
            <a class="muted-link" href="_sources/docker.md.txt"
               rel="nofollow">
              ソースコードを表示
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            コンテンツ
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Docker</a><ul>
<li><a class="reference internal" href="#id1">環境</a><ul>
<li><a class="reference internal" href="#id2">環境1</a></li>
<li><a class="reference internal" href="#id3">環境2</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">Dockerバージョン</a></li>
<li><a class="reference internal" href="#docker-engine">Docker Engineのインストール</a><ul>
<li><a class="reference internal" href="#id5">環境1,2共通</a></li>
<li><a class="reference internal" href="#docker-engine-debian">環境1: Docker Engineをインストールする Debian マシンを準備する</a></li>
<li><a class="reference internal" href="#docker-engine-centos8">環境2: Docker Engineをインストールする CentOS8 マシンを準備する</a></li>
<li><a class="reference internal" href="#linuxdocker-engine">LinuxマシンにDocker Engineをインストールする</a><ul>
<li><a class="reference internal" href="#debian-docker-engine">環境1: Debian に Docker Engine をインストールする</a></li>
<li><a class="reference internal" href="#centos7-docker-engine">環境2: CentOS7 に Docker Engine をインストールする</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id6">コンテナイメージ、イメージ</a><ul>
<li><a class="reference internal" href="#docker-hub">Docker Hub レジストリのイメージ一覧を見る</a></li>
<li><a class="reference internal" href="#id7">ローカルにあるイメージの一覧を得る</a></li>
<li><a class="reference internal" href="#id8">Docker Hub レジストリからイメージを得て、そのイメージを加える</a></li>
<li><a class="reference internal" href="#id9">イメージに変更を加えた別イメージを作る</a></li>
<li><a class="reference internal" href="#id10">公開するポートを指定したイメージを作る</a></li>
<li><a class="reference internal" href="#id11">マルチステージでイメージを作る</a></li>
<li><a class="reference internal" href="#id12">イメージをスキャンする</a></li>
<li><a class="reference internal" href="#id13">イメージを消す</a></li>
<li><a class="reference internal" href="#docker-hub-push">イメージを Docker Hub レジストリに push する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14">ボリューム</a><ul>
<li><a class="reference internal" href="#id15">ボリュームの一覧を得る</a></li>
<li><a class="reference internal" href="#id16">ボリュームを作る</a></li>
<li><a class="reference internal" href="#id17">ボリュームを消す</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18">コンテナ概要</a><ul>
<li><a class="reference internal" href="#id19">コンテナの一覧を得る</a></li>
<li><a class="reference internal" href="#id20">公開されているイメージから新しいコンテナを作って実行する</a></li>
<li><a class="reference internal" href="#id21">実行中のコンテナを停止する</a></li>
<li><a class="reference internal" href="#id22">コンテナを消す</a><ul>
<li><a class="reference internal" href="#bash">bash でコンテナを消す。</a></li>
<li><a class="reference internal" href="#powershell">PowerShell でコンテナを消す。</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id23">コンテナ単体</a><ul>
<li><a class="reference internal" href="#id24">コンテナを起動する時、指定コマンドを実行する</a></li>
<li><a class="reference internal" href="#id25">コンテナを起動する時、インタラクティブなコマンドを実行する</a></li>
<li><a class="reference internal" href="#id26">コンテナをデタッチで起動して、起動後にログを得る</a></li>
<li><a class="reference internal" href="#id27">コンテナを起動する時、環境変数を設定する</a></li>
<li><a class="reference internal" href="#id28">コンテナを起動する時、コンテナの名前をつける</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id29">Docker Engine とコンテナ</a><ul>
<li><a class="reference internal" href="#id30">Docker Engine サービス起動時にコンテナを起動する</a></li>
<li><a class="reference internal" href="#id31">Docker Engine を停止する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id32">コンテナとコンテナホスト間のネットワーク通信</a><ul>
<li><a class="reference internal" href="#tcp">コンテナを起動する時、コンテナホスト宛のTCP通信を、コンテナに転送する</a></li>
<li><a class="reference internal" href="#id33">コンテナ内から、コンテナホストより外に通信する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id34">コンテナとネットワーク</a><ul>
<li><a class="reference internal" href="#id35">ネットワークを作る</a></li>
<li><a class="reference internal" href="#id36">ネットワークに接続して、コンテナを起動する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id37">コンテナとコンテナホストのファイルアクセス</a><ul>
<li><a class="reference internal" href="#id38">ボリュームを接続して、コンテナを起動する</a></li>
<li><a class="reference internal" href="#bind-mount">bind mount を接続して、コンテナを起動する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#docker-compose">Docker Compose のインストール</a></li>
<li><a class="reference internal" href="#id39">コンテナ間通信、docker-compose</a><ul>
<li><a class="reference internal" href="#compose">Compose ファイルを作る</a></li>
<li><a class="reference internal" href="#docker-compose-yml">docker-compose.yml でコンテナを起動する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id40">コンテナイメージ</a><ul>
<li><a class="reference internal" href="#scratch">scratch コンテナイメージ</a><ul>
<li><a class="reference internal" href="#id41">scratch コンテナイメージとは</a></li>
<li><a class="reference internal" href="#id42">scratch イメージに対する調査</a><ul>
<li><a class="reference internal" href="#sh">sh を動かせるようにする</a></li>
<li><a class="reference internal" href="#find">find を動かせるようにする</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#debian-buster">debian:buster コンテナのイメージ</a><ul>
<li><a class="reference internal" href="#id43">ディレクトリ数、ファイル数を確認する</a></li>
<li><a class="reference internal" href="#ps">ps コマンドを実行する</a></li>
<li><a class="reference internal" href="#id44">指定パッケージをインストールしたコンテナのイメージを作る</a></li>
</ul>
</li>
<li><a class="reference internal" href="#centos-centos8">centos:centos8 コンテナのイメージ</a><ul>
<li><a class="reference internal" href="#id45">ディレクトリ数、ファイル数を確認する</a></li>
<li><a class="reference internal" href="#curl">curl コマンドを実行する</a></li>
<li><a class="reference internal" href="#id46">指定パッケージをインストールしたコンテナのイメージを作る</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nicolaka-netshoot">nicolaka/netshoot コンテナのイメージ</a><ul>
<li><a class="reference internal" href="#id47">ホスト名を解決する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#alpine">alpine コンテナのイメージ</a><ul>
<li><a class="reference internal" href="#id48">ディレクトリ数、ファイル数を確認する</a></li>
<li><a class="reference internal" href="#id49">指定パッケージをインストールしたコンテナのイメージを作る</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distroless">distroless コンテナのイメージ</a><ul>
<li><a class="reference internal" href="#todo">todo</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id50">レジストリ</a><ul>
<li><a class="reference internal" href="#id51">レジストリの種類</a></li>
<li><a class="reference internal" href="#id52">ローカルのレジストリを起動する</a></li>
<li><a class="reference internal" href="#id53">ローカルのレジストリを終了する</a></li>
<li><a class="reference internal" href="#id54">ローカルのレジストリを消す</a></li>
<li><a class="reference internal" href="#id55">ローカルのレジストリのストレージにホストの指定パスを指定する</a></li>
<li><a class="reference internal" href="#id56">ローカルレジストリを削除有効にして起動する</a></li>
<li><a class="reference internal" href="#id57">ローカルのレジストリのストレージ用のドライバを調べる</a></li>
<li><a class="reference internal" href="#id58">レジストリのイメージの一覧を得る</a></li>
<li><a class="reference internal" href="#id59">レジストリの指定イメージのタグ一覧を得る</a></li>
<li><a class="reference internal" href="#id60">レジストリにイメージを加える</a></li>
<li><a class="reference internal" href="#pull">レジストリを指定して pull する</a></li>
<li><a class="reference internal" href="#id61">レジストリからイメージを消す</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id62">調査、トラブルシュート</a><ul>
<li><a class="reference internal" href="#id63">インタラクティブなシェルを利用できるようにする</a></li>
<li><a class="reference internal" href="#id64">ネットワーク構成</a><ul>
<li><a class="reference internal" href="#ip">コンテナと、コンテナホストのIPネットワークを確認する</a></li>
<li><a class="reference internal" href="#id65">コンテナホストのIPネットワーク設定を得る</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id66">コンテナホストのディスク使用量を得る</a></li>
<li><a class="reference internal" href="#inspect">イメージを inspect で調べる</a></li>
<li><a class="reference internal" href="#id67">コンテナを inspect で調べる</a></li>
<li><a class="reference internal" href="#id68">ボリュームを inspect で調べる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tips">Tips</a><ul>
<li><a class="reference internal" href="#id69">すべてのオブジェクトを消す</a></li>
<li><a class="reference internal" href="#os">OSとコンテナの組み合わせでどのような動きになるか確認してみる</a><ul>
<li><a class="reference internal" href="#centos7-docker-engine-centos8">CentOS7 仮想マシンの Docker Engine で CentOS8 コンテナを起動する</a></li>
<li><a class="reference internal" href="#debian-docker-engine-centos8">Debian 仮想マシンの Docker Engine で CentOS8 コンテナを起動する</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id70">付録: docker コマンド出力</a><ul>
<li><a class="reference internal" href="#docker-version">docker version</a></li>
<li><a class="reference internal" href="#id71">docker</a></li>
<li><a class="reference internal" href="#docker-container">docker container</a></li>
<li><a class="reference internal" href="#docker-config">docker config</a></li>
<li><a class="reference internal" href="#docker-context">docker context</a></li>
<li><a class="reference internal" href="#docker-image">docker image</a></li>
<li><a class="reference internal" href="#docker-manifest">docker manifest</a></li>
<li><a class="reference internal" href="#docker-network">docker network</a></li>
<li><a class="reference internal" href="#docker-node">docker node</a></li>
<li><a class="reference internal" href="#docker-service">docker service</a></li>
<li><a class="reference internal" href="#docker-stack">docker stack</a></li>
<li><a class="reference internal" href="#docker-swarm">docker swarm</a></li>
<li><a class="reference internal" href="#docker-system">docker system</a></li>
<li><a class="reference internal" href="#docker-secret">docker secret</a></li>
<li><a class="reference internal" href="#docker-trust">docker trust</a></li>
<li><a class="reference internal" href="#docker-volume">docker volume</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id72">付録: docker-compose コマンド出力</a><ul>
<li><a class="reference internal" href="#docker-compose-version">docker-compose version</a></li>
<li><a class="reference internal" href="#id73">docker-compose</a></li>
<li><a class="reference internal" href="#sphinx">Sphinx のコードをビルドする</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/main.js"></script>
    <script src="_static/translations.js"></script>
    </body>
</html>